<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å„ç³»æ‰€æ³•è¦ç‰ˆæœ¬æ§ç®¡ç³»çµ±</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- SheetJS (XLSX) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
            color: #334155;
        }
        .font-num {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        
        .group:hover .group-hover-visible {
            opacity: 1;
            pointer-events: auto;
        }

        /* Soft card transitions */
        .card-transition {
            transition: all 0.2s ease-in-out;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Standard Note Templates ---
        const NOTE_TEMPLATES = [
            { label: "âœ… å·²ç¢ºèªæœ€æ–°", content: "ç¶“æŸ¥æ ¸ç¢ºèªï¼Œæœ¬æ³•è¦ç‚ºæœ€æ–°ç‰ˆæœ¬ï¼Œå·²å®Œæˆæé€æ ¡ç´šå§”å“¡æœƒå‚™æŸ¥ï¼Œä¸”æ³•è¦ç³»çµ±åŠç›¸é—œè³‡æ–™ä¸Šå‚³ç©ºé–“å…§å®¹çš†ç‚ºæœ€æ–°ã€‚" },
            { label: "âš ï¸ æ ¼å¼/é«”ä¾‹èª¿æ•´", content: "æœ¬æ³•è¦ä¾ yyy/mm/dd ç›¸é—œå‡½æ–‡èª¿æ•´æ¢æ–‡æ ¼å¼æˆ–é«”ä¾‹ï¼Œå±¬éå¯¦è³ªå…§å®¹ä¿®æ­£ï¼Œçˆ°é€•äºˆä¿®è¨‚ä¸¦ç°½è«‹æ ¡é•·æ ¸å‚™ã€‚" },
            { label: "âš ï¸ ç³»çµ±æœªæ›´æ–°(æ ¡ç´š)", content: "æ³•è¦ç³»çµ±å°šæœªæ›´æ–° yyy/mm/dd æ ¡ç´šå§”å“¡æœƒæ ¸äºˆå‚™æŸ¥ä¹‹æœ€æ–°ç‰ˆæœ¬ï¼Œç³»çµ±ç›®å‰ä»é¡¯ç¤ºèˆŠç‰ˆå…§å®¹ã€‚" },
            { label: "âš ï¸ åç¨±ä¿®æ­£æœªé€", content: "å› ç³»æ‰€åç¨±èª¿æ•´ï¼Œé…åˆæ³•è¦åç¨±ä¿®æ­£ï¼ŒæƒŸè©²åç¨±ä¿®æ­£æœªé€æ ¡ç´šå§”å“¡æœƒå‚™æŸ¥ï¼Œæœªæ¶‰åŠæ¢æ–‡å¯¦è³ªå…§å®¹ä¿®æ­£ã€‚" },
            { label: "âš ï¸ åƒ…ç³»/é™¢é€šé", content: "æœ¬æ³•è¦å·²æ–¼ yyy/mm/dd ç¶“é™¢å‹™æœƒè­°é€šéï¼ŒæƒŸå°šæœªæé€æ ¡ç´šå§”å“¡æœƒå‚™æŸ¥ã€‚" },
            { label: "â³ é€æ ¡ç´šå‚™æŸ¥ä¸­", content: "ä¿®æ­£è‰æ¡ˆå·²æ–¼ yyy/mm/dd ç¶“é™¢å‹™æœƒè­°ä¿®æ­£é€šéï¼Œä¸¦æé€æ ¡ç´šå§”å“¡æœƒå‚™æŸ¥ä¸­ã€‚" },
            { label: "ğŸ”´ æœªä¸Šå‚³ç³»çµ±", content: "æœ¬æ³•è¦å°šæœªä¸Šå‚³è‡³æ³•è¦ç³»çµ±ï¼Œäº¦æœªä¸Šå‚³è‡³æŒ‡å®šè³‡æ–™ä¸Šå‚³ç©ºé–“ã€‚" },
            { label: "ğŸ”´ æ­·æ¬¡ä¿®æ­£æœªé€", content: "æœ¬æ³•è¦æ›¾æ–¼ yyy/mm/dd ä¿®æ­£ï¼ŒæƒŸç›¸é—œä¿®æ­£å‡æœªé€æ ¡ç´šå§”å“¡æœƒå‚™æŸ¥ã€‚" },
            { label: "ğŸ”´ æ—¥æœŸæœªæ›´æ–°", content: "æ³•è¦ç³»çµ±æœªåŒæ­¥æ›´æ–°æ ¡ç´šå§”å“¡æœƒå‚™æŸ¥é€šéæ—¥æœŸï¼Œç³»çµ±ç™»è¼‰è³‡è¨Šèˆ‡å¯¦éš›æ ¸å®šæƒ…å½¢ä¸ä¸€è‡´ã€‚" },
            { label: "âš ï¸ é€šéå¾Œæœªé€", content: "æœ¬æ³•è¦å·²æ–¼ yyy/mm/dd ç¶“é™¢å‹™æœƒè­°é€šéï¼ŒæƒŸå°šæœªé€æ ¡ç´šå§”å“¡æœƒå‚™æŸ¥ã€‚" },
            { label: "â³ å°šå¾…é€æ ¡ç´š", content: "ä¿®æ­£è‰æ¡ˆå·²å®Œæˆç³»ç´šåŠé™¢ç´šå¯©è­°ç¨‹åºï¼Œå°šå¾…æé€æ ¡ç´šå§”å“¡æœƒå‚™æŸ¥ã€‚" }
        ];

        // --- Icons ---
        const ScaleIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M12 3v17.25m0 0c-1.472 0-2.882.265-4.185.75M12 20.25c1.472 0 2.882.265 4.185.75M18.75 4.97A48.416 48.416 0 0012 4.5c-2.291 0-4.545.16-6.75.47m13.5 0c1.01.143 2.01.317 3 .52m-3-.52l2.62 10.726c.122.499-.106 1.028-.589 1.202a5.988 5.988 0 01-2.031.352 5.988 5.988 0 01-2.031-.352c-.483-.174-.711-.703-.59-1.202L18.75 4.971zm-16.5.52c.99-.203 1.99-.377 3-.52m0 0l2.62 10.726c.122.499-.106 1.028-.589 1.202a5.989 5.989 0 01-2.031.352 5.989 5.989 0 01-2.031-.352c-.483-.174-.711-.703-.59-1.202L5.25 4.971z" /></svg>;
        const PlusIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>;
        const TrashIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>;
        const CheckIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>;
        const AlertIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>;
        const SaveIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>;
        const UploadIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" /></svg>;
        const HomeIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" /></svg>;
        const ArrowUpIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M4.5 10.5L12 3m0 0l7.5 7.5M12 3v18" /></svg>;
        const ArrowDownIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M19.5 13.5L12 21m0 0l-7.5-7.5M12 21V3" /></svg>;
        const ChevronUpIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M4.5 15.75l7.5-7.5 7.5 7.5" /></svg>;
        const ChevronDownIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg>;
        const XCircleIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M9.75 9.75l4.5 4.5m0-4.5l-4.5 4.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
        const TableIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 01-1.125-1.125M3.375 19.5h7.5c.621 0 1.125-.504 1.125-1.125m-9.75 0V5.625m0 12.75v-1.5c0-.621.504-1.125 1.125-1.125m18.375 2.625V5.625m0 12.75c0 .621-.504 1.125-1.125 1.125m1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125m0 0h-7.5m-3.75 0H3.375m13.5 0H16.5m-13.125-9h17.25c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125h-17.25c-.621 0-1.125-.504-1.125-1.125v-1.5c0-.621.504-1.125 1.125-1.125z" /></svg>;
        const CalendarIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={className}><path fillRule="evenodd" d="M6.75 2.25A.75.75 0 017.5 3v1.5h9V3A.75.75 0 0118 4.5v1.5h.75c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-15c-.621 0-1.125-.504-1.125-1.125V7.125C2.25 6.504 2.754 6 3.375 6H4.125V3A.75.75 0 014.875 2.25zM4.5 7.5v9.75h15V7.5H4.5z" clipRule="evenodd" /></svg>;
        const ChevronLeftIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" /></svg>;
        const ChevronRightIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>;
        const ClipboardIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184" /></svg>;
        const StarIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={className}><path fillRule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.007 5.404.433c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.433 2.082-5.006z" clipRule="evenodd" /></svg>;

        // --- Helper Functions ---
        const generateId = () => '_' + Math.random().toString(36).substr(2, 9);
        
        // Strict Status Check Logic: Reference vs Target
        // If reference is empty -> 'warning_source_missing'
        // If target is empty -> 'warning_missing'
        // If different -> 'warning_mismatch'
        const checkStatus = (refDate, targetDate) => {
            if (!refDate) return 'warning_source_missing'; 
            if (!targetDate) return 'warning_missing'; 
            return refDate === targetDate ? 'ok' : 'warning_mismatch';
        };

        const toROCDateStr = (dateStr) => {
            if (!dateStr) return '';
            const parts = dateStr.split('-');
            if (parts.length !== 3) return dateStr; 
            const year = parseInt(parts[0]) - 1911;
            return `${year}/${parts[1]}/${parts[2]}`;
        };

        const parseROCDateStr = (rocStr) => {
            if (!rocStr) return '';
            const cleanStr = rocStr.replace(/[^0-9]/g, '');
            if (cleanStr.length < 6 || cleanStr.length > 7) return null;

            let year, month, day;
            if (cleanStr.length === 7) {
                year = parseInt(cleanStr.substring(0, 3));
                month = cleanStr.substring(3, 5);
                day = cleanStr.substring(5, 7);
            } else {
                year = parseInt(cleanStr.substring(0, 2));
                month = cleanStr.substring(2, 4);
                day = cleanStr.substring(4, 6);
            }

            const adYear = year + 1911;
            return `${adYear}-${month}-${day}`;
        };

        const initialData = [];

        // --- UI Sub-Components (Badge & Icons) ---
        const StatusBadge = ({ status }) => {
            if (status === 'empty') return <span className="text-gray-400 text-xs bg-gray-100 px-2 py-0.5 rounded-full border border-gray-200">å¾…ç¢ºèª</span>;
            if (status === 'ok') return (
                <div className="flex items-center text-emerald-600 text-xs font-bold bg-emerald-50 px-2 py-0.5 rounded-full border border-emerald-100">
                    <CheckIcon className="w-3.5 h-3.5 mr-1" /> åŒæ­¥
                </div>
            );
            return (
                <div className="flex items-center text-red-500 text-xs font-bold bg-red-50 px-2 py-0.5 rounded-full border border-red-100">
                    <AlertIcon className="w-3.5 h-3.5 mr-1" /> æœªåŒæ­¥
                </div>
            );
        };

        const TableStatusBadge = ({ status, label }) => {
            if (status === 'empty') return <span className="text-gray-400 text-xs">-</span>;
            if (status === 'ok') return <span className="text-emerald-600 text-xs font-bold flex items-center gap-1"><CheckIcon className="w-3 h-3"/> {label}</span>;
            return <span className="text-red-500 text-xs font-bold flex items-center gap-1"><AlertIcon className="w-3 h-3"/> æœªåŒæ­¥</span>;
        }

        // --- Custom ROC Date Picker Component (Popup) ---
        const CustomROCDatePicker = ({ isOpen, onClose, dateValue, onChange, position }) => {
            const pickerRef = useRef(null);
            const [viewYear, setViewYear] = useState(() => dateValue ? parseInt(dateValue.split('-')[0]) : new Date().getFullYear());
            const [viewMonth, setViewMonth] = useState(() => dateValue ? parseInt(dateValue.split('-')[1]) - 1 : new Date().getMonth());

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (pickerRef.current && !pickerRef.current.contains(event.target) && !event.target.closest('.date-input-trigger')) {
                        onClose();
                    }
                };
                if (isOpen) document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, [isOpen, onClose]);

            const changeMonth = (offset) => {
                let newMonth = viewMonth + offset;
                let newYear = viewYear;
                if (newMonth > 11) { newMonth = 0; newYear++; }
                else if (newMonth < 0) { newMonth = 11; newYear--; }
                setViewMonth(newMonth);
                setViewYear(newYear);
            };

            const handleDateClick = (day) => {
                const yyyy = viewYear;
                const mm = String(viewMonth + 1).padStart(2, '0');
                const dd = String(day).padStart(2, '0');
                onChange(`${yyyy}-${mm}-${dd}`);
                onClose();
            };

            const daysInMonth = new Date(viewYear, viewMonth + 1, 0).getDate();
            const firstDay = new Date(viewYear, viewMonth, 1).getDay();
            const daysArray = Array(firstDay).fill(null).concat([...Array(daysInMonth).keys()].map(i => i + 1));
            const rocYear = viewYear - 1911;

            if (!isOpen) return null;

            return (
                <div 
                    ref={pickerRef}
                    className="absolute z-50 bg-white rounded-lg shadow-xl border border-gray-200 p-4 w-64 animate-fade-in"
                    style={{ top: '100%', right: 0, marginTop: '4px' }} 
                >
                    <div className="flex justify-between items-center mb-3">
                        <button onClick={() => changeMonth(-1)} className="p-1 hover:bg-gray-100 rounded text-gray-500"><ChevronLeftIcon className="w-5 h-5"/></button>
                        <div className="font-bold text-gray-700 text-sm">æ°‘åœ‹ {rocYear} å¹´ {viewMonth + 1} æœˆ</div>
                        <button onClick={() => changeMonth(1)} className="p-1 hover:bg-gray-100 rounded text-gray-500"><ChevronRightIcon className="w-5 h-5"/></button>
                    </div>
                    <div className="grid grid-cols-7 gap-1 text-center text-xs mb-1 text-gray-400 font-medium">
                        <div className="text-red-400">æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
                    </div>
                    <div className="grid grid-cols-7 gap-1">
                        {daysArray.map((day, i) => (
                            <div key={i} className="aspect-square">
                                {day && (
                                    <button 
                                        onClick={() => handleDateClick(day)}
                                        className={`w-full h-full flex items-center justify-center rounded-full text-xs transition-colors
                                            ${dateValue === `${viewYear}-${String(viewMonth+1).padStart(2,'0')}-${String(day).padStart(2,'0')}` 
                                                ? 'bg-blue-600 text-white font-bold' 
                                                : 'text-gray-700 hover:bg-blue-50'}
                                        `}
                                    >
                                        {day}
                                    </button>
                                )}
                            </div>
                        ))}
                    </div>
                    <div className="mt-3 pt-2 border-t border-gray-100 flex justify-center">
                        <button onClick={() => { 
                            const now = new Date(); 
                            onChange(`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`);
                            onClose();
                        }} className="text-xs text-blue-600 font-bold hover:underline">ä»Šå¤©</button>
                    </div>
                </div>
            );
        };

        // --- Note Template Picker ---
        const NoteTemplatePicker = ({ onSelect, onClose }) => {
            const pickerRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (pickerRef.current && !pickerRef.current.contains(event.target)) {
                        onClose();
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, [onClose]);

            return (
                <div 
                    ref={pickerRef}
                    className="absolute z-50 bg-white rounded-lg shadow-xl border border-gray-200 w-80 max-h-96 overflow-y-auto animate-fade-in"
                    style={{ top: '100%', right: 0, marginTop: '4px' }}
                >
                    <div className="sticky top-0 bg-gray-50 border-b border-gray-100 px-4 py-2 text-xs font-bold text-gray-500 uppercase flex justify-between items-center">
                        <span>é¸æ“‡å¸¸ç”¨å‚™è¨» (å¯å¤šé¸)</span>
                        <button onClick={onClose} className="text-gray-400 hover:text-gray-600">âœ•</button>
                    </div>
                    <div className="p-2 space-y-1">
                        {NOTE_TEMPLATES.map((tpl, idx) => (
                            <button
                                key={idx}
                                onClick={() => onSelect(tpl.content)}
                                className="w-full text-left p-2 hover:bg-blue-50 rounded-md transition-colors group"
                            >
                                <div className="text-sm font-bold text-gray-700 mb-1">{tpl.label}</div>
                                <div className="text-xs text-gray-500 line-clamp-2 group-hover:text-blue-600">{tpl.content}</div>
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        const DateInput = ({ label, dateValue, onChange, status, isBenchmark }) => {
            const [inputValue, setInputValue] = useState(toROCDateStr(dateValue));
            const [isPickerOpen, setIsPickerOpen] = useState(false);

            useEffect(() => {
                setInputValue(toROCDateStr(dateValue));
            }, [dateValue]);

            const handleTextChange = (e) => {
                const val = e.target.value;
                setInputValue(val);
                const parsed = parseROCDateStr(val);
                if (parsed) onChange(parsed);
            };

            const handleBlur = () => {
                if (!inputValue) {
                    onChange('');
                } else {
                    const parsed = parseROCDateStr(inputValue);
                    if (parsed) {
                        onChange(parsed);
                        setInputValue(toROCDateStr(parsed));
                    } else {
                        setInputValue(toROCDateStr(dateValue));
                    }
                }
            };

            const clearDate = (e) => {
                e.stopPropagation();
                onChange('');
                setInputValue('');
            };

            let statusClass = "bg-white border-gray-200 focus-within:border-blue-400 focus-within:ring-2 focus-within:ring-blue-100";
            let badge = null;

            if (isBenchmark) {
                // Special style for Benchmark Date
                statusClass = "bg-amber-50 border-amber-200 focus-within:border-amber-400 focus-within:ring-amber-100";
                if (!dateValue) {
                    badge = <span className="text-amber-600 text-xs font-bold flex items-center gap-1"><AlertIcon className="w-3 h-3"/> åŸºæº–æœªå®š</span>;
                } else {
                    badge = <span className="text-amber-600 text-xs font-bold flex items-center gap-1"><StarIcon className="w-3 h-3"/> æ¯”è¼ƒåŸºæº–</span>;
                }
            } else {
                if (status === 'warning_source_missing') { // No benchmark set
                    statusClass = "bg-gray-50 border-gray-200";
                    badge = <span className="text-gray-400 text-xs">--</span>;
                } else if (status === 'warning_missing') {
                    statusClass = "bg-red-50 border-red-200 focus-within:border-red-400 focus-within:ring-red-100";
                    badge = <span className="text-red-500 text-xs font-bold flex items-center gap-1"><AlertIcon className="w-3 h-3"/> æœªä¸Šå‚³</span>;
                } else if (status === 'warning_mismatch') {
                    statusClass = "bg-red-50 border-red-200 focus-within:border-red-400 focus-within:ring-red-100";
                    badge = <span className="text-red-500 text-xs font-bold flex items-center gap-1"><AlertIcon className="w-3 h-3"/> æœªåŒæ­¥</span>;
                } else if (status === 'ok') {
                    statusClass = "bg-emerald-50 border-emerald-200 focus-within:border-emerald-400 focus-within:ring-emerald-100";
                    badge = <span className="text-emerald-600 text-xs font-bold flex items-center gap-1"><CheckIcon className="w-3 h-3"/> åŒæ­¥</span>;
                }
            }

            return (
                <div className={`p-3 rounded-xl border transition-all ${statusClass} flex flex-col gap-1 relative`}>
                    <div className="flex justify-between items-center mb-1">
                        <span className={`text-[11px] font-bold uppercase tracking-wide ${isBenchmark ? 'text-amber-700' : 'text-gray-500'}`}>{label}</span>
                        {badge}
                    </div>
                    
                    <div className="relative flex items-center w-full">
                        <input 
                            type="text" 
                            className={`w-full bg-transparent text-sm font-num outline-none pr-8 ${!dateValue ? 'text-red-500 font-bold placeholder-red-300' : 'text-gray-700 placeholder-gray-400'}`}
                            placeholder="æœªä¸Šå‚³"
                            value={inputValue}
                            onChange={handleTextChange}
                            onBlur={handleBlur}
                        />
                        <div className="absolute right-0 flex items-center gap-1">
                            {inputValue && (
                                <button onClick={clearDate} className="p-1 text-gray-300 hover:text-red-500 transition-colors" tabIndex={-1}>
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" className="w-4 h-4"><path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" /></svg>
                                </button>
                            )}
                            <button 
                                className="date-input-trigger p-1 text-gray-400 hover:text-blue-600 transition-colors"
                                onClick={() => setIsPickerOpen(!isPickerOpen)}
                                tabIndex={-1}
                            >
                                <CalendarIcon className="w-5 h-5" />
                            </button>
                        </div>
                        <CustomROCDatePicker 
                            isOpen={isPickerOpen} 
                            onClose={() => setIsPickerOpen(false)} 
                            dateValue={dateValue}
                            onChange={(val) => { onChange(val); setInputValue(toROCDateStr(val)); }}
                        />
                    </div>
                </div>
            );
        };

        const RegulationRow = ({ reg, onUpdate, onDelete }) => {
            const [isTemplateOpen, setIsTemplateOpen] = useState(false);
            
            // New Logic: Everything compares against latestDate
            // If latestDate is missing, everything is uncertain ('warning_source_missing')
            const latestStatus = !reg.latestDate ? 'warning_source_missing' : 'ok';
            const meetingStatus = checkStatus(reg.latestDate, reg.meetingDate);
            const cloudStatus = checkStatus(reg.latestDate, reg.cloudDate);
            const systemStatus = checkStatus(reg.latestDate, reg.systemDate);

            return (
                <div className="bg-white border border-gray-100 rounded-xl p-4 mb-3 shadow-sm hover:shadow-md transition-shadow card-transition relative z-10 group focus-within:z-50 hover:z-30">
                    <div className="flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between mb-4 pb-3 border-b border-gray-100">
                        <input 
                            type="text" 
                            value={reg.name}
                            onChange={(e) => onUpdate({ ...reg, name: e.target.value })}
                            className="font-bold text-gray-700 text-base bg-transparent border-b border-transparent hover:border-gray-300 focus:border-blue-400 px-1 py-0.5 outline-none w-full sm:w-2/3 transition-colors rounded-md"
                            placeholder="è¼¸å…¥æ³•è¦åç¨±..."
                        />
                        <button onClick={onDelete} className="text-gray-400 hover:text-red-500 transition-colors flex items-center gap-1 text-xs px-2 py-1 rounded-lg hover:bg-red-50">
                            <TrashIcon className="w-4 h-4" /> åˆªé™¤
                        </button>
                    </div>

                    <div className="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-3 mb-3 relative z-20">
                        <DateInput label="æœ€æ–°ç‰ˆæœ¬æ—¥æœŸ" dateValue={reg.latestDate} onChange={(val) => onUpdate({ ...reg, latestDate: val })} isBenchmark={true} />
                        <DateInput label="æ ¡ç´šæœƒè­°" dateValue={reg.meetingDate} onChange={(val) => onUpdate({ ...reg, meetingDate: val })} status={meetingStatus} />
                        <DateInput label="ç³»æ‰€é›²ç«¯" dateValue={reg.cloudDate} onChange={(val) => onUpdate({ ...reg, cloudDate: val })} status={cloudStatus} />
                        <DateInput label="æ³•è¦ç³»çµ±" dateValue={reg.systemDate} onChange={(val) => onUpdate({ ...reg, systemDate: val })} status={systemStatus} />
                    </div>
                    
                    <div className="flex items-start gap-3 mt-2 px-1 relative z-10">
                        <span className="text-xs font-medium text-gray-400 mt-2">å‚™è¨»</span>
                        <div className="flex-1 relative flex items-start">
                            <textarea 
                                value={reg.note || ''}
                                onChange={(e) => onUpdate({ ...reg, note: e.target.value })}
                                className="w-full text-xs text-gray-600 bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 pr-8 focus:outline-none focus:border-blue-300 focus:bg-white focus:ring-2 focus:ring-blue-50 transition-all min-h-[40px] resize-y"
                                placeholder="é»æ“Šè¼¸å…¥å‚™è¨»ï¼Œæˆ–ä½¿ç”¨å³å´æŒ‰éˆ•é¸æ“‡æ¨£æ¿..."
                                rows={1}
                            />
                            <button 
                                onClick={() => setIsTemplateOpen(!isTemplateOpen)}
                                className="absolute right-2 top-2 text-gray-400 hover:text-blue-600 transition-colors p-1"
                                title="é¸æ“‡å¸¸ç”¨å‚™è¨»"
                            >
                                <ClipboardIcon className="w-4 h-4" />
                            </button>
                            
                            {isTemplateOpen && (
                                <NoteTemplatePicker 
                                    onSelect={(text) => {
                                        const newNote = reg.note ? reg.note + '\n' + text : text;
                                        onUpdate({ ...reg, note: newNote });
                                    }}
                                    onClose={() => setIsTemplateOpen(false)} 
                                />
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const RegulationListSection = ({ title, list, onUpdateList, badgeColor }) => {
            const add = () => onUpdateList([...list, { id: generateId(), name: '', latestDate: '', meetingDate: '', cloudDate: '', systemDate: '', note: '' }]);
            const update = (item) => onUpdateList(list.map(i => i.id === item.id ? item : i));
            const remove = (id) => confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ") && onUpdateList(list.filter(i => i.id !== id));

            return (
                <div className="flex-1 min-w-[300px] flex flex-col">
                    <div className="flex items-center justify-between mb-4 pl-1">
                        <h4 className="font-bold text-gray-700 text-sm tracking-wide flex items-center gap-2">
                            {title}
                            <span className={`text-[10px] px-2 py-0.5 rounded-full font-num text-white ${badgeColor}`}>{list.length}</span>
                        </h4>
                        <button onClick={add} className="text-blue-500 hover:text-white hover:bg-blue-500 border border-blue-200 hover:border-blue-500 text-xs px-3 py-1.5 rounded-full transition-all flex items-center gap-1 shadow-sm">
                            <PlusIcon className="w-3 h-3" /> æ–°å¢é …ç›®
                        </button>
                    </div>
                    <div className="space-y-4">
                        {list.length === 0 && <div className="text-sm text-gray-400 text-center py-10 bg-gray-50/50 border border-dashed border-gray-200 rounded-xl">å°šç„¡é …ç›®ï¼Œè«‹é»æ“Šæ–°å¢</div>}
                        {list.map(item => <RegulationRow key={item.id} reg={item} onUpdate={update} onDelete={() => remove(item.id)} />)}
                    </div>
                </div>
            );
        };

        const DepartmentView = ({ dept, onUpdate, onDelete, onMoveUp, onMoveDown, isFirst, isLast }) => {
            const [isCollapsed, setIsCollapsed] = useState(false);
            
            const allRules = [...(dept.committeeRules || []), ...(dept.internshipRules || [])];
            const totalRules = allRules.length;
            const warnings = allRules.filter(r => 
                !r.latestDate || 
                checkStatus(r.latestDate, r.meetingDate) !== 'ok' ||
                checkStatus(r.latestDate, r.cloudDate) !== 'ok' ||
                checkStatus(r.latestDate, r.systemDate) !== 'ok'
            ).length;

            return (
                <div className="bg-white border border-gray-200 mb-6 shadow-sm hover:shadow-md transition-all rounded-2xl">
                    <div className={`bg-white px-6 py-4 border-b border-gray-100 flex justify-between items-center cursor-pointer hover:bg-gray-50 transition-colors rounded-t-2xl ${isCollapsed ? 'rounded-2xl border-b-0' : ''}`} onClick={() => setIsCollapsed(!isCollapsed)}>
                        <div className="flex items-center gap-4 flex-1">
                            <button className="text-gray-400 hover:text-blue-500 transition-colors">{isCollapsed ? <ChevronDownIcon className="w-5 h-5" /> : <ChevronUpIcon className="w-5 h-5" />}</button>
                            <div className="flex items-center gap-3 flex-1" onClick={(e) => e.stopPropagation()}>
                                <span className="bg-slate-100 text-slate-500 text-[10px] px-2 py-1 rounded-md font-bold tracking-wider">å­¸ç³»</span>
                                <input value={dept.name} onChange={(e) => onUpdate({...dept, name: e.target.value})} className="text-lg font-bold text-slate-700 bg-transparent border-b border-transparent hover:border-gray-300 focus:border-blue-400 focus:outline-none transition-colors" />
                            </div>
                            <div className="flex gap-2">
                                <span className="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded-full font-num">å…± {totalRules} é …</span>
                                {warnings > 0 && <span className="text-xs bg-red-100 text-red-600 px-2 py-1 rounded-full font-bold flex items-center gap-1"><AlertIcon className="w-3 h-3" /> {warnings} æœªåŒæ­¥</span>}
                            </div>
                        </div>
                        <div className="flex items-center gap-1 ml-4" onClick={(e) => e.stopPropagation()}>
                             <button onClick={onMoveUp} disabled={isFirst} className={`p-2 rounded-full ${isFirst ? 'text-gray-200 cursor-not-allowed' : 'text-gray-400 hover:bg-blue-50 hover:text-blue-600'}`}><ArrowUpIcon className="w-4 h-4" /></button>
                            <button onClick={onMoveDown} disabled={isLast} className={`p-2 rounded-full ${isLast ? 'text-gray-200 cursor-not-allowed' : 'text-gray-400 hover:bg-blue-50 hover:text-blue-600'}`}><ArrowDownIcon className="w-4 h-4" /></button>
                            <div className="w-px h-4 bg-gray-200 mx-2"></div>
                            <button onClick={onDelete} className="text-gray-300 hover:text-red-500 hover:bg-red-50 p-2 rounded-full transition-colors"><TrashIcon className="w-4 h-4" /></button>
                        </div>
                    </div>
                    {!isCollapsed && (
                        <div className="p-6 bg-slate-50/50 flex flex-col xl:flex-row gap-8 animate-fade-in rounded-b-2xl">
                            <RegulationListSection title="å§”å“¡æœƒè¨­ç½®è¦é»" list={dept.committeeRules || []} onUpdateList={(newList) => onUpdate({...dept, committeeRules: newList})} badgeColor="bg-blue-400" />
                            <div className="hidden xl:block w-px bg-gray-200"></div>
                            <RegulationListSection title="å¯¦ç¿’è¾¦æ³•" list={dept.internshipRules || []} onUpdateList={(newList) => onUpdate({...dept, internshipRules: newList})} badgeColor="bg-emerald-400" />
                        </div>
                    )}
                </div>
            );
        };

        const ReportView = ({ data }) => {
            const allItems = useMemo(() => {
                const items = [];
                data.forEach(col => col.departments.forEach(dept => {
                    const push = (t, r) => items.push({ colName: col.name, deptName: dept.name, type: t, ...r });
                    (dept.committeeRules || []).forEach(r => push('å§”å“¡æœƒè¨­ç½®è¦é»', r));
                    (dept.internshipRules || []).forEach(r => push('å¯¦ç¿’è¾¦æ³•', r));
                }));
                return items;
            }, [data]);

            if (allItems.length === 0) return <div className="flex flex-col items-center justify-center h-[60vh] text-center text-gray-400">å°šç„¡è³‡æ–™</div>;

            return (
                <div className="animate-fade-in w-full max-w-[1800px] mx-auto pb-20 px-4">
                    <header className="flex items-center justify-between mb-6">
                        <h2 className="text-2xl font-bold text-slate-700 flex items-center gap-3"><span className="bg-indigo-100 p-2 rounded-lg text-indigo-600"><TableIcon className="w-6 h-6" /></span> è©³ç´°å ±è¡¨</h2>
                        <div className="text-sm text-gray-500 font-num">å…± {allItems.length} ç­†è³‡æ–™</div>
                    </header>
                    <div className="bg-white border border-gray-200 rounded-2xl shadow-sm overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-gray-50 text-gray-500 font-medium border-b border-gray-200">
                                    <tr>
                                        <th className="px-6 py-4 min-w-[150px]">å­¸é™¢/å­¸ç³»</th>
                                        <th className="px-6 py-4 min-w-[200px]">æ³•è¦åç¨±</th>
                                        <th className="px-4 py-4 min-w-[120px]">æœ€æ–°ç‰ˆæœ¬</th>
                                        <th className="px-4 py-4 min-w-[120px]">æ ¡ç´šæœƒè­°</th>
                                        <th className="px-4 py-4 min-w-[120px]">ç³»æ‰€é›²ç«¯</th>
                                        <th className="px-4 py-4 min-w-[120px]">æ³•è¦ç³»çµ±</th>
                                        <th className="px-6 py-4 min-w-[300px]">å‚™è¨»</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100">
                                    {allItems.map((item, idx) => {
                                        const meetingStatus = checkStatus(item.latestDate, item.meetingDate);
                                        const cloudStatus = checkStatus(item.latestDate, item.cloudDate);
                                        const systemStatus = checkStatus(item.latestDate, item.systemDate);
                                        
                                        return (
                                            <tr key={idx} className="hover:bg-gray-50/50 transition-colors">
                                                <td className="px-6 py-4"><div className="font-bold text-slate-700">{item.deptName}</div><div className="text-xs text-gray-400">{item.colName}</div></td>
                                                <td className="px-6 py-4"><div className="font-medium text-slate-800">{item.name || '(æœªå‘½å)'}</div><div className="text-xs text-gray-400 inline-block px-1.5 py-0.5 rounded bg-gray-100 mt-1">{item.type}</div></td>
                                                <td className="px-4 py-4">
                                                    <div className={`font-num font-bold ${!item.latestDate ? 'text-red-500' : 'text-amber-600'}`}>{toROCDateStr(item.latestDate) || 'æœªè¨­å®š'}</div>
                                                </td>
                                                <td className="px-4 py-4"><div className={`font-num ${!item.meetingDate ? 'text-red-500 font-bold' : 'text-slate-600'}`}>{toROCDateStr(item.meetingDate) || 'æœªä¸Šå‚³'}</div><div className="mt-1"><TableStatusBadge status={meetingStatus} label="æ ¡ç´š" /></div></td>
                                                <td className="px-4 py-4"><div className={`font-num ${!item.cloudDate ? 'text-red-500 font-bold' : 'text-slate-600'}`}>{toROCDateStr(item.cloudDate) || 'æœªä¸Šå‚³'}</div><div className="mt-1"><TableStatusBadge status={cloudStatus} label="é›²ç«¯" /></div></td>
                                                <td className="px-4 py-4"><div className={`font-num ${!item.systemDate ? 'text-red-500 font-bold' : 'text-slate-600'}`}>{toROCDateStr(item.systemDate) || 'æœªä¸Šå‚³'}</div><div className="mt-1"><TableStatusBadge status={systemStatus} label="ç³»çµ±" /></div></td>
                                                <td className="px-6 py-4 text-gray-500 text-xs break-words whitespace-pre-wrap">{item.note || '-'}</td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ data }) => {
            let totalItems = 0;
            let warningItems = [];

            data.forEach(col => col.departments.forEach(dept => {
                const rules = [...(dept.committeeRules || []), ...(dept.internshipRules || [])];
                rules.forEach(r => {
                    totalItems++;
                    
                    const isLatestMissing = !r.latestDate;
                    const isMeetingMismatch = checkStatus(r.latestDate, r.meetingDate) !== 'ok';
                    const isCloudMismatch = checkStatus(r.latestDate, r.cloudDate) !== 'ok';
                    const isSystemMismatch = checkStatus(r.latestDate, r.systemDate) !== 'ok';
                    
                    if (isLatestMissing || isMeetingMismatch || isCloudMismatch || isSystemMismatch) {
                        const issues = [];
                        if (isLatestMissing) issues.push('æœ€æ–°ç‰ˆæœ¬æ—¥æœŸæœªè¨­å®š');
                        else {
                            // If benchmark exists, show specific mismatches
                            const benchmark = toROCDateStr(r.latestDate);
                            if (isMeetingMismatch) {
                                const current = r.meetingDate ? toROCDateStr(r.meetingDate) : 'æœªä¸Šå‚³';
                                issues.push(`æ ¡ç´šä¸ç¬¦ (æº–:${benchmark} ç¾:${current})`);
                            }
                            if (isCloudMismatch) {
                                const current = r.cloudDate ? toROCDateStr(r.cloudDate) : 'æœªä¸Šå‚³';
                                issues.push(`é›²ç«¯ä¸ç¬¦ (æº–:${benchmark} ç¾:${current})`);
                            }
                            if (isSystemMismatch) {
                                const current = r.systemDate ? toROCDateStr(r.systemDate) : 'æœªä¸Šå‚³';
                                issues.push(`ç³»çµ±ä¸ç¬¦ (æº–:${benchmark} ç¾:${current})`);
                            }
                        }
                        
                        warningItems.push({
                            college: col.name,
                            dept: dept.name,
                            name: r.name,
                            issue: issues.join('ã€')
                        });
                    }
                });
            }));

            if (data.length === 0) return <div className="flex flex-col items-center justify-center h-[60vh] text-center text-gray-400">è«‹å…ˆæ–°å¢å­¸é™¢</div>;

            return (
                <div className="space-y-8 animate-fade-in max-w-7xl mx-auto">
                    <header className="flex items-center justify-between pb-2">
                        <h2 className="text-2xl font-bold text-slate-700 flex items-center gap-3">ç¸½è¡¨å„€è¡¨æ¿</h2>
                        <div className="text-sm text-gray-400 font-num bg-white px-3 py-1 rounded-full shadow-sm border border-gray-100">æœ€å¾Œæ›´æ–°: {toROCDateStr(new Date().toISOString().split('T')[0])}</div>
                    </header>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm hover:shadow-md transition-shadow">
                            <div className="text-gray-400 text-xs font-bold uppercase tracking-wider mb-2">è¿½è¹¤ç¸½é …ç›®</div>
                            <div className="text-4xl font-bold text-slate-700 font-num">{totalItems}</div>
                        </div>
                        <div className="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm hover:shadow-md transition-shadow">
                            <div className="text-emerald-500 text-xs font-bold uppercase tracking-wider mb-2">ç‹€æ…‹åŒæ­¥</div>
                            <div className="text-4xl font-bold text-emerald-500 font-num">{totalItems - warningItems.length}</div>
                        </div>
                        <div className="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm hover:shadow-md transition-shadow">
                            <div className="text-red-500 text-xs font-bold uppercase tracking-wider mb-2">éœ€æ›´æ–°é …ç›®</div>
                            <div className="text-4xl font-bold text-red-500 font-num">{warningItems.length}</div>
                        </div>
                    </div>
                    <div className="bg-white border border-gray-100 rounded-2xl shadow-sm overflow-hidden">
                        <div className="bg-gray-50/50 px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                            <h3 className="font-bold text-slate-600 flex items-center gap-2"><AlertIcon className="w-5 h-5 text-red-400" /> å¾…è™•ç†æ¸…å–®</h3>
                            <span className="bg-red-100 text-red-600 text-xs font-bold px-2.5 py-1 rounded-full">{warningItems.length}</span>
                        </div>
                        {warningItems.length === 0 ? <div className="p-12 text-center text-slate-400">ç›®å‰æ‰€æœ‰æ³•è¦ç‰ˆæœ¬çš†å·²åŒæ­¥ã€‚</div> : 
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left">
                                    <thead className="bg-gray-50/50 text-gray-400 uppercase text-[11px] tracking-wider border-b border-gray-50">
                                        <tr><th className="px-6 py-3 pl-8">å­¸é™¢ / å­¸ç³»</th><th className="px-6 py-3">æ³•è¦åç¨±</th><th className="px-6 py-3">å•é¡Œæè¿°</th></tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-50">
                                        {warningItems.map((item, idx) => (
                                            <tr key={idx} className="hover:bg-gray-50/80 transition-colors">
                                                <td className="px-6 py-4 pl-8"><div className="font-bold text-slate-700">{item.dept}</div><div className="text-xs text-gray-400">{item.college}</div></td>
                                                <td className="px-6 py-4 font-medium text-slate-600">{item.name}</td>
                                                <td className="px-6 py-4"><span className="inline-flex items-center gap-1 text-red-600 bg-red-50 px-2.5 py-1 rounded-full border border-red-100 text-xs font-bold"><AlertIcon className="w-3 h-3" /> {item.issue}</span></td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        }
                    </div>
                </div>
            );
        };

        const App = () => {
            const [data, setData] = useState(() => {
                const saved = localStorage.getItem('reg_tracker_v4'); // Updated version key
                try { return saved ? JSON.parse(saved) : initialData; } catch { return initialData; }
            });
            const [activeTab, setActiveTab] = useState('dashboard');
            const [isSidebarOpen, setSidebarOpen] = useState(true);

            useEffect(() => localStorage.setItem('reg_tracker_v4', JSON.stringify(data)), [data]);

            const addCollege = () => { const id = generateId(); setData([...data, { id, name: 'æ–°å­¸é™¢', departments: [] }]); setActiveTab(id); };
            const updateCollege = (c) => setData(data.map(x => x.id === c.id ? c : x));
            const deleteCollege = (id) => { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { setData(data.filter(x => x.id !== id)); if(activeTab===id) setActiveTab('dashboard'); }};
            const activeCollege = data.find(c => c.id === activeTab);

            const handleFileExport = () => {
                const rows = [];
                data.forEach(col => col.departments.forEach(dept => {
                    const push = (t, r) => rows.push({'å­¸é™¢ID':col.id, 'å­¸é™¢åç¨±':col.name, 'å­¸ç³»ID':dept.id, 'å­¸ç³»åç¨±':dept.name, 'æ³•è¦é¡å‹':t, 'æ³•è¦ID':r.id, 'æ³•è¦åç¨±':r.name, 'æœ€æ–°ç‰ˆæœ¬æ—¥æœŸ': r.latestDate, 'æ ¡ç´šæœƒè­°æ—¥æœŸ':r.meetingDate, 'ç³»æ‰€é›²ç«¯æ—¥æœŸ':r.cloudDate, 'æ³•è¦ç³»çµ±æ—¥æœŸ':r.systemDate, 'å‚™è¨»':r.note});
                    (dept.committeeRules || []).forEach(r => push('å§”å“¡æœƒè¨­ç½®è¦é»', r));
                    (dept.internshipRules || []).forEach(r => push('å¯¦ç¿’è¾¦æ³•', r));
                }));
                if(!rows.length) return alert("ç›®å‰æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º");
                
                const worksheet = XLSX.utils.json_to_sheet(rows);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "æ³•è¦ç‰ˆæœ¬");
                XLSX.writeFile(workbook, `RegTracker_${new Date().toISOString().split('T')[0]}.xlsx`);
            };
            
            const handleFileImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const workbook = XLSX.read(evt.target.result, { type: 'array' });
                        const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                        const newData = [];
                        const colMap = {};
                        jsonData.forEach(row => {
                            const colId = row['å­¸é™¢ID'] || generateId();
                            let col = colMap[colId];
                            if (!col) { col = { id: colId, name: row['å­¸é™¢åç¨±'] || 'æœªå‘½å', departments: [] }; colMap[colId] = col; newData.push(col); }
                            const deptId = row['å­¸ç³»ID'] || generateId();
                            let dept = col.departments.find(d => d.id === deptId);
                            if (!dept) { dept = { id: deptId, name: row['å­¸ç³»åç¨±'] || 'æœªå‘½å', committeeRules: [], internshipRules: [] }; col.departments.push(dept); }
                            if (row['æ³•è¦åç¨±']) {
                                const rule = {
                                    id: row['æ³•è¦ID'] || generateId(),
                                    name: row['æ³•è¦åç¨±'],
                                    latestDate: row['æœ€æ–°ç‰ˆæœ¬æ—¥æœŸ'] || '',
                                    meetingDate: row['æ ¡ç´šæœƒè­°æ—¥æœŸ'] || '',
                                    cloudDate: row['ç³»æ‰€é›²ç«¯æ—¥æœŸ'] || '',
                                    systemDate: row['æ³•è¦ç³»çµ±æ—¥æœŸ'] || '',
                                    note: row['å‚™è¨»'] || ''
                                };
                                row['æ³•è¦é¡å‹'] === 'å¯¦ç¿’è¾¦æ³•' ? dept.internshipRules.push(rule) : dept.committeeRules.push(rule);
                            }
                        });
                        if (confirm(`åŒ¯å…¥å°‡è¦†è“‹ç¾æœ‰è³‡æ–™ï¼Œç¢ºå®šï¼Ÿ`)) setData(newData);
                    } catch (err) { alert("åŒ¯å…¥å¤±æ•—"); }
                };
                reader.readAsArrayBuffer(file);
            };

            return (
                <div className="flex h-screen overflow-hidden bg-slate-50">
                    <aside className={`${isSidebarOpen ? 'w-72' : 'w-0'} bg-white border-r border-gray-200 flex-shrink-0 transition-all duration-300 flex flex-col z-20`}>
                        <div className="h-auto py-6 px-6 bg-white border-b border-gray-100 flex flex-row items-center gap-4">
                            <div className="bg-blue-600 p-2 rounded-xl shadow-md shadow-blue-200 flex-shrink-0"><ScaleIcon className="w-8 h-8 text-white" /></div>
                            <div className="flex flex-col"><div className="text-[10px] font-bold text-gray-500 tracking-wide uppercase">æ±æµ·å¤§å­¸å¯¦ç¿’èˆ‡å­¸ç”Ÿæˆå°±ä¸­å¿ƒ</div><h1 className="font-bold text-gray-800 text-lg tracking-wide leading-tight">ç³»æ‰€æ³•è¦æ§ç®¡ç³»çµ±</h1></div>
                        </div>
                        <nav className="flex-1 overflow-y-auto p-4 space-y-1">
                            <button onClick={() => setActiveTab('dashboard')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition-all ${activeTab === 'dashboard' ? 'bg-blue-50 text-blue-700 font-bold' : 'hover:bg-gray-50 text-gray-500 hover:text-gray-900'}`}><HomeIcon className="w-5 h-5" /> ç¸½è¡¨ç€è¦½</button>
                            <button onClick={() => setActiveTab('report')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition-all ${activeTab === 'report' ? 'bg-indigo-50 text-indigo-700 font-bold' : 'hover:bg-gray-50 text-gray-500 hover:text-gray-900'}`}><TableIcon className="w-5 h-5" /> è©³ç´°å ±è¡¨</button>
                            <div className="mt-6 mb-2 px-4 flex justify-between items-center"><span className="text-[10px] font-bold text-gray-400 uppercase tracking-widest">å­¸é™¢ç®¡ç†</span></div>
                            {data.map((col) => (
                                <div key={col.id} className="group relative flex items-center mb-1">
                                    <button onClick={() => setActiveTab(col.id)} className={`flex-1 flex items-center gap-3 px-4 py-2.5 rounded-xl text-sm transition-all ${activeTab === col.id ? 'bg-gray-100 text-gray-900 font-bold' : 'hover:bg-gray-50 text-gray-500 hover:text-gray-900'}`}>
                                        <span className="truncate flex-1 text-left">{col.name}</span>
                                        {col.departments.some(d => [...d.committeeRules, ...d.internshipRules].some(r => !r.latestDate || checkStatus(r.latestDate, r.meetingDate)!=='ok' || checkStatus(r.latestDate, r.cloudDate)!=='ok' || checkStatus(r.latestDate, r.systemDate)!=='ok')) && <span className="w-2 h-2 bg-red-500 rounded-full shadow-sm"></span>}
                                    </button>
                                </div>
                            ))}
                            <button onClick={addCollege} className="w-full flex items-center justify-center gap-2 mt-6 px-4 py-3 border border-dashed border-gray-300 rounded-xl text-xs text-gray-400 hover:border-blue-400 hover:text-blue-600 hover:bg-blue-50 transition-all"><PlusIcon className="w-4 h-4" /> æ–°å¢å­¸é™¢</button>
                        </nav>
                        <div className="p-4 border-t border-gray-100 bg-gray-50"><div className="flex gap-3 justify-center"><label className="cursor-pointer flex-1 bg-white hover:bg-gray-50 text-gray-600 py-2 rounded-lg text-xs flex items-center justify-center gap-2 transition-all border border-gray-200 shadow-sm"><UploadIcon className="w-4 h-4" /> åŒ¯å…¥<input type="file" accept=".xlsx" onChange={handleFileImport} className="hidden" /></label><button onClick={handleFileExport} className="flex-1 bg-gray-800 hover:bg-gray-900 text-white py-2 rounded-lg text-xs flex items-center justify-center gap-2 transition-all shadow-md"><SaveIcon className="w-4 h-4" /> å‚™ä»½</button></div></div>
                    </aside>
                    <main className="flex-1 flex flex-col min-w-0 bg-[#f8fafc] overflow-hidden relative">
                        <div className="h-16 flex items-center px-4 border-b border-gray-100 bg-white lg:hidden"><button onClick={() => setSidebarOpen(!isSidebarOpen)} className="p-2 -ml-2 text-gray-500"><svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></button></div>
                        <div className="flex-1 overflow-y-auto p-6 sm:p-10 scroll-smooth">
                            {activeTab === 'dashboard' && <Dashboard data={data} />}
                            {activeTab === 'report' && <ReportView data={data} />}
                            {activeTab !== 'dashboard' && activeTab !== 'report' && activeCollege && (
                                <div className="w-full max-w-[1800px] mx-auto animate-fade-in pb-20 px-4 sm:px-6">
                                    <div className="flex items-center justify-between mb-8 pb-4 border-b border-gray-200">
                                        <div className="flex items-center gap-4"><div className="w-14 h-14 bg-white border border-gray-100 rounded-2xl shadow-sm flex items-center justify-center text-blue-600"><ScaleIcon className="w-8 h-8" /></div><div><div className="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">ç·¨è¼¯å­¸é™¢</div><input value={activeCollege.name} onChange={(e) => updateCollege({...activeCollege, name: e.target.value})} className="text-3xl font-bold text-gray-800 bg-transparent border-b-2 border-transparent hover:border-gray-200 focus:border-blue-500 focus:outline-none w-full transition-all" /></div></div>
                                        <button onClick={() => deleteCollege(activeCollege.id)} className="text-gray-400 hover:text-red-500 hover:bg-red-50 px-4 py-2 rounded-xl transition-colors text-sm font-medium flex items-center gap-2"><TrashIcon className="w-4 h-4" /> åˆªé™¤å­¸é™¢</button>
                                    </div>
                                    <div className="space-y-6">
                                        {activeCollege.departments.map((dept, index) => (
                                            <DepartmentView 
                                                key={dept.id} dept={dept} isFirst={index===0} isLast={index===activeCollege.departments.length-1}
                                                onMoveUp={() => { const newDepts = [...activeCollege.departments]; [newDepts[index], newDepts[index-1]] = [newDepts[index-1], newDepts[index]]; updateCollege({...activeCollege, departments: newDepts}); }}
                                                onMoveDown={() => { const newDepts = [...activeCollege.departments]; [newDepts[index], newDepts[index+1]] = [newDepts[index+1], newDepts[index]]; updateCollege({...activeCollege, departments: newDepts}); }}
                                                onUpdate={(u) => updateCollege({...activeCollege, departments: activeCollege.departments.map(d => d.id === u.id ? u : d)})}
                                                onDelete={() => { if(confirm("åˆªé™¤å­¸ç³»ï¼Ÿ")) updateCollege({...activeCollege, departments: activeCollege.departments.filter(d => d.id !== dept.id)}) }}
                                            />
                                        ))}
                                    </div>
                                    <button onClick={() => updateCollege({...activeCollege, departments: [...activeCollege.departments, { id: generateId(), name: 'æ–°å­¸ç³»', committeeRules: [], internshipRules: [] }]})} className="w-full py-6 mt-6 border-2 border-dashed border-gray-300 rounded-2xl text-gray-400 font-medium hover:border-blue-400 hover:text-blue-500 hover:bg-blue-50/50 transition-all flex items-center justify-center gap-2 group"><div className="p-2 bg-gray-100 group-hover:bg-blue-100 rounded-full transition-colors text-gray-500 group-hover:text-blue-500"><PlusIcon className="w-5 h-5" /></div> æ–°å¢å­¸ç³»åˆ°æ­¤å­¸é™¢</button>
                                </div>
                            )}
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
