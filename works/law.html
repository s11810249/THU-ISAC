<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»æ‰€æ³•è¦æ§ç®¡ç³»çµ± Pro V19</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                        num: ['"Inter"', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            50: '#f4f7fb',
                            100: '#e9eef5',
                            200: '#cedce9',
                            300: '#a2bed7',
                            400: '#709bc0',
                            500: '#4a78a0',
                            600: '#3c658d',
                            700: '#315273',
                            800: '#2c4660',
                            900: '#293c51',
                            950: '#1b2736',
                        },
                    },
                    boxShadow: {
                        'soft': '0 2px 10px rgba(44, 70, 96, 0.03)',
                        'timeline': '0 0 0 3px #fff', 
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f4f7fb; color: #2c4660; -webkit-font-smoothing: antialiased; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .animate-fade-in { animation: fadeIn 0.25s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Clean Input Style (Bottom Border Only) */
        .clean-input { 
            background-color: transparent;
            border: none;
            border-bottom: 1px solid #e2e8f0;
            border-radius: 0;
            padding: 4px 0;
            transition: all 0.2s;
        }
        .clean-input:hover { border-bottom-color: #cbd5e1; }
        .clean-input:focus { border-bottom-color: #4a78a0; outline: none; box-shadow: 0 1px 0 0 #4a78a0; }
        
        .nav-item:hover { background-color: rgba(74, 120, 160, 0.05); color: #3c658d; }
        .nav-item.active { background-color: #e9eef5; color: #2c4660; font-weight: 600; }
        
        .btn-action { transition: all 0.2s; }
        .btn-action:active { transform: scale(0.95); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Icons ---
        const Icons = {
            ScaleBalanced: (p) => <i className={`fa-solid fa-scale-balanced ${p.className||''}`}></i>,
            Building: (p) => <i className={`fa-solid fa-building-columns ${p.className||''}`}></i>,
            Dept: (p) => <i className={`fa-solid fa-graduation-cap ${p.className||''}`}></i>,
            Cloud: (p) => <i className={`fa-solid fa-cloud ${p.className||''}`}></i>,
            Scale: (p) => <i className={`fa-solid fa-scale-balanced ${p.className||''}`}></i>,
            History: (p) => <i className={`fa-solid fa-clock-rotate-left ${p.className||''}`}></i>,
            Check: (p) => <i className={`fa-solid fa-circle-check ${p.className||''}`}></i>,
            Alert: (p) => <i className={`fa-solid fa-triangle-exclamation ${p.className||''}`}></i>,
            Plus: (p) => <i className={`fa-solid fa-plus ${p.className||''}`}></i>,
            Trash: (p) => <i className={`fa-solid fa-trash-can ${p.className||''}`}></i>,
            ChevronDown: (p) => <i className={`fa-solid fa-chevron-down ${p.className||''}`}></i>,
            ChevronUp: (p) => <i className={`fa-solid fa-chevron-up ${p.className||''}`}></i>,
            ChevronRight: (p) => <i className={`fa-solid fa-chevron-right ${p.className||''}`}></i>,
            ChevronLeft: (p) => <i className={`fa-solid fa-chevron-left ${p.className||''}`}></i>,
            XCircle: (p) => <i className={`fa-solid fa-circle-xmark ${p.className||''}`}></i>,
            Save: (p) => <i className={`fa-solid fa-file-export ${p.className||''}`}></i>,
            Upload: (p) => <i className={`fa-solid fa-file-import ${p.className||''}`}></i>,
            Home: (p) => <i className={`fa-solid fa-house ${p.className||''}`}></i>,
            Table: (p) => <i className={`fa-solid fa-table ${p.className||''}`}></i>,
            Clipboard: (p) => <i className={`fa-regular fa-clipboard ${p.className||''}`}></i>,
            Star: (p) => <i className={`fa-solid fa-star ${p.className||''}`}></i>,
            ArrowUp: (p) => <i className={`fa-solid fa-arrow-up ${p.className||''}`}></i>,
            ArrowDown: (p) => <i className={`fa-solid fa-arrow-down ${p.className||''}`}></i>,
            Calendar: (p) => <i className={`fa-regular fa-calendar ${p.className||''}`}></i>,
            Edit: (p) => <i className={`fa-solid fa-pen-to-square ${p.className||''}`}></i>,
            Clock: (p) => <i className={`fa-regular fa-clock ${p.className||''}`}></i>,
            Manage: (p) => <i className={`fa-solid fa-gear ${p.className||''}`}></i>,
            Dot: (p) => <i className={`fa-solid fa-circle ${p.className||''}`}></i>,
            FileCheck: (p) => <i className={`fa-solid fa-file-circle-check ${p.className||''}`}></i>,
            ThumbUp: (p) => <i className={`fa-solid fa-thumbs-up ${p.className||''}`}></i>,
            Wrench: (p) => <i className={`fa-solid fa-screwdriver-wrench ${p.className||''}`}></i>,
            Gavel: (p) => <i className={`fa-solid fa-gavel ${p.className||''}`}></i>
        };

        const DEFAULT_NOTE_TEMPLATES = [
            { id: 1, label: "âœ… å·²ç¢ºèªæœ€æ–°", content: "ç¶“æŸ¥æ ¸ç¢ºèªï¼Œæœ¬æ³•è¦ç‚ºæœ€æ–°ç‰ˆæœ¬ï¼Œå·²å®Œæˆæé€æ ¡ç´šå§”å“¡æœƒå‚™æŸ¥ï¼Œä¸”æ³•è¦ç³»çµ±åŠç›¸é—œè³‡æ–™ä¸Šå‚³ç©ºé–“å…§å®¹çš†ç‚ºæœ€æ–°ã€‚" },
            { id: 2, label: "âš ï¸ æ ¼å¼/é«”ä¾‹èª¿æ•´", content: "æœ¬æ³•è¦ä¾ yyy/mm/dd ç›¸é—œå‡½æ–‡èª¿æ•´æ¢æ–‡æ ¼å¼æˆ–é«”ä¾‹ï¼Œå±¬éå¯¦è³ªå…§å®¹ä¿®æ­£ï¼Œçˆ°é€•äºˆä¿®è¨‚ä¸¦ç°½è«‹æ ¡é•·æ ¸å‚™ã€‚" },
            { id: 3, label: "âš ï¸ ç³»çµ±æœªæ›´æ–°", content: "æ³•è¦ç³»çµ±å°šæœªæ›´æ–° yyy/mm/dd æ ¡ç´šå§”å“¡æœƒæ ¸äºˆå‚™æŸ¥ä¹‹æœ€æ–°ç‰ˆæœ¬ï¼Œç³»çµ±ç›®å‰ä»é¡¯ç¤ºèˆŠç‰ˆå…§å®¹ã€‚" },
            { id: 4, label: "âš ï¸ åç¨±ä¿®æ­£æœªé€", content: "å› ç³»æ‰€åç¨±èª¿æ•´ï¼Œé…åˆæ³•è¦åç¨±ä¿®æ­£ï¼ŒæƒŸè©²åç¨±ä¿®æ­£æœªé€æ ¡ç´šå§”å“¡æœƒå‚™æŸ¥ï¼Œæœªæ¶‰åŠæ¢æ–‡å¯¦è³ªå…§å®¹ä¿®æ­£ã€‚" },
            { id: 5, label: "â³ é€æ ¡ç´šå‚™æŸ¥ä¸­", content: "ä¿®æ­£è‰æ¡ˆå·²æ–¼ yyy/mm/dd ç¶“é™¢å‹™æœƒè­°ä¿®æ­£é€šéï¼Œä¸¦æé€æ ¡ç´šå§”å“¡æœƒå‚™æŸ¥ä¸­ã€‚" },
            { id: 6, label: "ğŸ”´ æœªä¸Šå‚³ç³»çµ±", content: "æœ¬æ³•è¦å°šæœªä¸Šå‚³è‡³æ³•è¦ç³»çµ±ï¼Œäº¦æœªä¸Šå‚³è‡³æŒ‡å®šè³‡æ–™ä¸Šå‚³ç©ºé–“ã€‚" }
        ];

        const PROCESS_TYPES = [
            { id: 'standard', label: 'ä¸€èˆ¬ä¿®æ³•' },
            { id: 'direct', label: 'æˆæ¬Šé€•äºˆä¿®è¨‚' }, 
            { id: 'name_change', label: 'æ³•è¦åç¨±è®Šæ›´' },
            { id: 'format', label: 'åƒ…æ ¼å¼èª¿æ•´' }
        ];

        const DEPT_MEETING_TYPES = [
            { val: 'affairs', label: 'ç³»å‹™æœƒè­°' },
            { val: 'preparatory', label: 'ç³»ç±Œå‚™æœƒè­°' },
            { val: 'internship', label: 'ç³»å¯¦ç¿’å§”å“¡æœƒ' },
            { val: 'none', label: 'ç„¡ç³»ç´š' }
        ];
        const COLLEGE_MEETING_TYPES = [
            { val: 'affairs', label: 'é™¢å‹™æœƒè­°' },
            { val: 'internship', label: 'é™¢å¯¦ç¿’å§”å“¡æœƒ' }
        ];

        const generateId = () => '_' + Math.random().toString(36).substr(2, 9);
        const toROC = (date) => { if (!date) return ''; const p = date.split('-'); return p.length === 3 ? `${parseInt(p[0])-1911}/${p[1]}/${p[2]}` : date; };
        const parseROC = (val) => { const v = val.replace(/[^0-9]/g, ''); if (v.length < 6) return null; let y, m, d; if (v.length === 7) { y=parseInt(v.substring(0,3)); m=v.substring(3,5); d=v.substring(5,7); } else { y=parseInt(v.substring(0,2)); m=v.substring(2,4); d=v.substring(4,6); } return `${y+1911}-${m}-${d}`; };

        const checkStatus = (refDate, targetDate) => {
            if (!refDate) return 'warning_source_missing'; 
            if (!targetDate) return 'warning_missing'; 
            return refDate === targetDate ? 'ok' : 'warning_mismatch';
        };

        const initialData = [];

        // --- UI Components ---
        const StatusBadge = ({ status }) => {
            if (status === 'empty') return <span className="text-gray-400 text-xs bg-gray-100 px-2 py-0.5 rounded-full border border-gray-200">å¾…ç¢ºèª</span>;
            if (status === 'ok') return (
                <div className="flex items-center text-emerald-600 text-xs font-bold bg-emerald-50 px-2 py-0.5 rounded-full border border-emerald-100">
                    <Icons.Check className="mr-1 text-xs" /> åŒæ­¥
                </div>
            );
            return (
                <div className="flex items-center text-red-500 text-xs font-bold bg-red-50 px-2 py-0.5 rounded-full border border-red-100">
                    <Icons.Alert className="mr-1 text-xs" /> æœªåŒæ­¥
                </div>
            );
        };

        // --- æŸ¥æ ¸æŒ‰éˆ•å…ƒä»¶ (For History) ---
        const VerificationButton = ({ isVerified, onToggle, label }) => {
            return (
                <button 
                    onClick={onToggle}
                    className={`flex items-center justify-center p-1.5 rounded-full transition-all border ${isVerified 
                        ? 'bg-blue-100 text-blue-600 border-blue-200 hover:bg-blue-200' 
                        : 'bg-gray-100 text-gray-300 border-gray-200 hover:text-gray-400 hover:bg-gray-200'}`}
                    title={label || "é»æ“Šåˆ‡æ›æœƒè­°ç´€éŒ„ç¢ºèªç‹€æ…‹"}
                >
                    <Icons.FileCheck className="text-sm" />
                </button>
            );
        };

        const CustomROCDatePicker = ({ isOpen, onClose, dateValue, onChange }) => {
            const pickerRef = useRef(null);
            const [viewYear, setViewYear] = useState(() => dateValue ? parseInt(dateValue.split('-')[0]) : new Date().getFullYear());
            const [viewMonth, setViewMonth] = useState(() => dateValue ? parseInt(dateValue.split('-')[1]) - 1 : new Date().getMonth());
            useEffect(() => { const h = (e) => { if (pickerRef.current && !pickerRef.current.contains(e.target) && !e.target.closest('.date-input-trigger')) onClose(); }; if(isOpen) document.addEventListener('mousedown', h); return () => document.removeEventListener('mousedown', h); }, [isOpen]);
            const changeMonth = (offset) => { let nm = viewMonth + offset, ny = viewYear; if(nm>11){nm=0;ny++;}else if(nm<0){nm=11;ny--;} setViewMonth(nm); setViewYear(ny); };
            const handleDateClick = (d) => { onChange(`${viewYear}-${String(viewMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`); onClose(); };
            const daysInMonth = new Date(viewYear, viewMonth+1, 0).getDate();
            const firstDay = new Date(viewYear, viewMonth, 1).getDay();
            const days = Array(firstDay).fill(null).concat([...Array(daysInMonth).keys()].map(i=>i+1));
            if(!isOpen) return null;
            return (
                <div ref={pickerRef} className="absolute z-50 bg-white rounded-lg shadow-xl border border-gray-200 p-4 w-64 animate-fade-in" style={{top:'100%', right:0, marginTop:'4px'}}>
                    <div className="flex justify-between items-center mb-3">
                        <button onClick={()=>changeMonth(-1)} className="p-1 hover:bg-gray-100 rounded text-gray-500"><Icons.ChevronLeft /></button>
                        <div className="font-bold text-gray-700 text-sm">æ°‘åœ‹ {viewYear-1911} å¹´ {viewMonth+1} æœˆ</div>
                        <button onClick={()=>changeMonth(1)} className="p-1 hover:bg-gray-100 rounded text-gray-500"><Icons.ChevronRight /></button>
                    </div>
                    <div className="grid grid-cols-7 gap-1 text-center text-xs mb-1 text-gray-400 font-medium"><div className="text-red-400">æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div></div>
                    <div className="grid grid-cols-7 gap-1">{days.map((d,i)=>(<div key={i} className="aspect-square">{d && <button onClick={()=>handleDateClick(d)} className={`w-full h-full flex items-center justify-center rounded-full text-xs transition-colors ${dateValue===`${viewYear}-${String(viewMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`?'bg-primary-600 text-white font-bold':'text-gray-700 hover:bg-primary-50'}`}>{d}</button>}</div>))}</div>
                    <div className="mt-3 pt-2 border-t border-gray-100 flex justify-center"><button onClick={()=>{const n=new Date();onChange(`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')}`);onClose();}} className="text-xs text-blue-600 font-bold hover:underline">ä»Šå¤©</button></div>
                </div>
            );
        };

        const DateInput = ({ label, dateValue, onChange, placeholder = "yyy/mm/dd", disabled = false, status, isBenchmark }) => {
            const [val, setVal] = useState(toROC(dateValue));
            const [open, setOpen] = useState(false);
            useEffect(() => setVal(toROC(dateValue)), [dateValue]);
            const handleChange = (e) => { setVal(e.target.value); const p = parseROC(e.target.value); if(p) onChange(p); };
            const handleBlur = () => { const p = parseROC(val); if(p) { onChange(p); setVal(toROC(p)); } else if(!val) { onChange(''); } else { setVal(toROC(dateValue)); } };
            const clearDate = (e) => { e.stopPropagation(); onChange(''); setVal(''); };

            let statusClass = "bg-white/50 backdrop-blur-sm border-white/60 shadow-sm focus-within:bg-white/95 focus-within:shadow-md focus-within:ring-2 focus-within:ring-blue-100 focus-within:border-blue-300";
            let badge = null;

            if (isBenchmark) {
                statusClass = "bg-amber-50/50 backdrop-blur-sm border-amber-200/60 focus-within:bg-white/95 focus-within:border-amber-400 focus-within:ring-amber-100";
                badge = dateValue ? <span className="text-amber-600 text-xs font-bold flex items-center gap-1"><Icons.Star className="text-[10px]"/> åŸºæº–</span> : <span className="text-amber-600 text-xs font-bold flex items-center gap-1"><Icons.Alert className="text-[10px]"/> æœªå®š</span>;
            } else if (status?.startsWith('warning')) {
                const text = status === 'warning_source_missing' ? 'æœªè¨­å®š' : 'æœªåŒæ­¥';
                const labelColor = 'text-red-500';
                statusClass = "bg-red-50/50 backdrop-blur-sm border-red-200/60 focus-within:bg-white/95 focus-within:border-red-400 focus-within:ring-red-100";
                badge = <span className={`${labelColor} text-xs font-bold flex items-center gap-1`}><Icons.Alert className="text-[10px]"/> {text}</span>;
            } else if (status === 'ok') {
                statusClass = "bg-emerald-50/50 backdrop-blur-sm border-emerald-200/60 focus-within:bg-white/95 focus-within:border-emerald-400 focus-within:ring-emerald-100";
                badge = <span className="text-emerald-600 text-xs font-bold flex items-center gap-1"><Icons.Check className="text-[10px]"/> åŒæ­¥</span>;
            }

            return (
                <div className={`p-3 rounded-lg border transition-all ${statusClass} flex flex-col gap-1 relative ${disabled ? 'opacity-60 pointer-events-none bg-gray-100/50' : ''}`}>
                    <div className="flex justify-between items-center mb-1">
                        <span className={`text-[10px] font-bold uppercase tracking-wide ${isBenchmark ? 'text-amber-700' : 'text-gray-500'}`}>{label}</span>
                        {badge}
                    </div>
                    <div className="relative flex items-center w-full">
                        <input type="text" disabled={disabled} className={`w-full bg-transparent outline-none text-sm font-num placeholder-gray-400/70 pr-8 ${!dateValue && !disabled ? 'text-red-500 font-bold placeholder-red-300' : 'text-gray-700'}`} placeholder={disabled ? '-' : "æœªä¸Šå‚³"} value={val} onChange={handleChange} onBlur={handleBlur} />
                        <div className="absolute right-0 flex items-center gap-1">
                            {val && !disabled && <button onClick={clearDate} className="text-gray-300 hover:text-red-500 transition-colors"><Icons.XCircle className="text-sm"/></button>}
                            <button disabled={disabled} className={`date-input-trigger ${disabled ? 'text-gray-300' : 'text-gray-400 hover:text-blue-600'}`} onClick={()=>setOpen(!open)}><Icons.Calendar className="text-sm"/></button>
                        </div>
                    </div>
                    { !disabled && <CustomROCDatePicker isOpen={open} onClose={()=>setOpen(false)} dateValue={dateValue} onChange={(v)=>{onChange(v); setVal(toROC(v));}} /> }
                </div>
            );
        };

        const TemplateManager = ({ templates, onClose, onChange }) => {
            const [local, setLocal] = useState(templates);
            const save = () => { onChange(local); onClose(); };
            const add = () => setLocal([...local, { id: generateId(), label: 'æ–°å‚™è¨»', content: '' }]);
            const remove = (idx) => setLocal(local.filter((_,i)=>i!==idx));
            const update = (i, f, v) => { const n=[...local]; n[i][f]=v; setLocal(n); };

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[80vh] overflow-hidden flex flex-col animate-fade-in">
                        <div className="bg-slate-900 text-white px-6 py-4 flex justify-between items-center" style={{backgroundColor: '#1e293b'}}>
                            <h3 className="font-bold text-lg">ç®¡ç†å¸¸ç”¨å‚™è¨»</h3>
                            <button onClick={onClose}><Icons.XCircle className="text-lg hover:text-red-400"/></button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-6 bg-primary-50 space-y-4">
                            {local.map((t, i) => (
                                <div key={t.id || i} className="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex gap-3 hover:shadow-md transition-all">
                                    <div className="flex-1 space-y-2">
                                        <input value={t.label} onChange={e=>update(i,'label',e.target.value)} className="w-full text-sm font-bold border-b border-dashed border-gray-300 focus:border-blue-500 outline-none pb-1" placeholder="æ¨™é¡Œ"/>
                                        <textarea value={t.content} onChange={e=>update(i,'content',e.target.value)} className="w-full text-xs border border-gray-200 rounded p-2 focus:border-blue-500 outline-none resize-none h-16 bg-gray-50 focus:bg-white transition-colors" placeholder="å…§å®¹..."></textarea>
                                    </div>
                                    <button onClick={()=>remove(i)} className="text-gray-300 hover:text-red-500 self-start p-1"><Icons.Trash className="text-base"/></button>
                                </div>
                            ))}
                            <button onClick={add} className="w-full py-3 border-2 border-dashed border-gray-300 text-gray-400 rounded-lg hover:border-blue-500 hover:text-blue-600 font-bold flex justify-center items-center gap-2 hover:bg-white transition-all"><Icons.Plus className="text-base"/> æ–°å¢æ¨¡æ¿</button>
                        </div>
                        <div className="p-4 bg-white border-t border-gray-200 flex justify-end gap-2">
                            <button onClick={onClose} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg text-sm font-medium transition-colors">å–æ¶ˆ</button>
                            <button onClick={save} className="px-6 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded-lg text-sm font-bold shadow-sm shadow-blue-500/30 transition-all active:scale-95">å„²å­˜è®Šæ›´</button>
                        </div>
                    </div>
                </div>
            );
        };

        const NoteTemplatePicker = ({ templates, onSelect, onClose, onManage, safeAreaRef }) => {
            const ref = useRef(null);
            useEffect(() => { 
                const h = (e) => { 
                    if(ref.current && !ref.current.contains(e.target)) {
                        if(safeAreaRef && safeAreaRef.current && safeAreaRef.current.contains(e.target)) return;
                        onClose();
                    }
                }; 
                document.addEventListener('mousedown', h); return () => document.removeEventListener('mousedown', h); 
            }, [onClose, safeAreaRef]);
            return (
                <div ref={ref} className="absolute z-50 bg-white rounded-lg shadow-xl border border-gray-200 w-80 max-h-96 overflow-y-auto animate-fade-in left-0 top-full mt-1 flex flex-col">
                    <div className="sticky top-0 bg-primary-50 border-b border-gray-100 px-4 py-3 text-xs font-bold text-primary-500 uppercase flex justify-between items-center">
                        <span>é¸æ“‡å‚™è¨» (å¤šé¸)</span>
                        <div className="flex gap-2">
                            <button onClick={onManage} className="text-blue-600 hover:text-blue-800 flex items-center gap-1" title="ç®¡ç†æ¨¡æ¿"><Icons.Manage className="text-xs"/> ç®¡ç†</button>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600"><Icons.XCircle className="text-sm"/></button>
                        </div>
                    </div>
                    <div className="p-2 space-y-1 flex-1 overflow-y-auto">
                        {templates.map((t,i)=><button key={i} onClick={()=>onSelect(t.content)} className="w-full text-left p-3 hover:bg-primary-50 rounded-lg group transition-colors border border-transparent hover:border-primary-100"><div className="text-sm font-bold text-gray-700 mb-1 group-hover:text-blue-700">{t.label}</div><div className="text-xs text-gray-500 line-clamp-2 group-hover:text-blue-600">{t.content}</div></button>)}
                    </div>
                </div>
            );
        };

        const Timeline = ({ history }) => {
            if (!history || history.length === 0) return null;
            
            const sortedHistory = [...history].sort((a, b) => {
                const dateA = a.univDate || a.collegeDate || a.deptDate || '';
                const dateB = b.univDate || b.collegeDate || b.deptDate || '';
                return dateB.localeCompare(dateA); 
            });

            return (
                <div className="border-t border-gray-100 mt-6 pt-6">
                    <div className="flex items-center gap-2 mb-4">
                        <div className="bg-primary-100 p-1.5 rounded-lg text-primary-600">
                            <Icons.History className="text-sm" />
                        </div>
                        <span className="text-sm font-bold text-primary-700">ä¿®æ³•æ­·ç¨‹æ™‚é–“è»¸</span>
                    </div>
                    
                    <div className="relative space-y-8 pl-4">
                        <div className="absolute left-6 top-2 bottom-4 w-[2px] bg-gray-200 -translate-x-1/2"></div>

                        {sortedHistory.map((h, i) => {
                             const isDirect = h.type === 'direct' || h.type === 'name_change' || h.type === 'format';
                             
                             if (isDirect) {
                                 let displayLabel = h.label;
                                 if (h.univDate) {
                                    const parts = h.univDate.split('-');
                                    const y = parseInt(parts[0]) - 1911;
                                    const m = parseInt(parts[1]);
                                    const d = parseInt(parts[2]);
                                    displayLabel = `ä¾ ${y} å¹´ ${m} æœˆ ${d} æ—¥ ${h.issueNumber||'______'}å‡½è¾¦ç†ï¼Œ${h.directUnit || '______'}`;
                                 }

                                 return (
                                    <div key={h.id} className="relative pl-12">
                                        <div className={`absolute left-6 top-3 w-4 h-4 rounded-full border-2 border-white box-content shadow-timeline z-10 -translate-x-1/2 ${i===0 ? 'bg-primary-600' : 'bg-gray-400'}`}></div>
                                        <div className="bg-white border border-gray-200 rounded-lg p-3 shadow-sm relative">
                                            <div className="flex flex-col sm:flex-row sm:items-baseline justify-between gap-1 mb-2">
                                                <div className="flex flex-col">
                                                    <span className="text-xs font-bold text-gray-400 uppercase tracking-wider">{PROCESS_TYPES.find(p=>p.id===(h.type||'standard'))?.label}</span>
                                                    <span className="font-bold text-slate-700 text-sm">{displayLabel}</span>
                                                </div>
                                                {h.univDate && <span className="bg-primary-50 text-primary-700 text-xs px-2 py-1 rounded font-num font-bold">{toROC(h.univDate)}</span>}
                                            </div>
                                            {h.note && <div className="text-xs text-gray-500 whitespace-pre-wrap pl-2 border-l-2 border-gray-300">{h.note}</div>}
                                        </div>
                                    </div>
                                 );
                             }

                             const steps = [];
                             if (h.deptMeetingType !== 'none') {
                                 // æ–°å¢åˆ¤æ–·ï¼šå¦‚æœæ˜¯ preparatory å‰‡é¡¯ç¤º 'ç±Œå‚™æœƒè­°'
                                 let suffix = 'å‹™æœƒè­°';
                                 if (h.deptMeetingType === 'internship') suffix = 'å¯¦ç¿’å§”å“¡æœƒ';
                                 else if (h.deptMeetingType === 'preparatory' || h.deptMeetingType === 'preparatory ') suffix = 'ç±Œå‚™æœƒè­°';
                                 
                                 steps.push({ key: 'dept', label: 'ç³»', suffix: suffix, date: h.deptDate });
                             }
                             steps.push({ key: 'college', label: 'é™¢', suffix: h.collegeMeetingType === 'internship' ? 'å¯¦ç¿’å§”å“¡æœƒ' : 'å‹™æœƒè­°', date: h.collegeDate });
                             steps.push({ key: 'univ', label: 'æ ¡ç´š', suffix: 'å¯¦ç¿’å§”å“¡æœƒ', date: h.univDate });

                             return (
                                <div key={h.id} className="relative pl-12">
                                    <div className={`absolute left-6 top-3 w-4 h-4 rounded-full border-2 border-white box-content shadow-timeline z-10 -translate-x-1/2 ${i===0 ? 'bg-primary-600' : 'bg-gray-400'}`}></div>
                                    <div className="bg-slate-50 border border-slate-100 rounded-lg p-4 shadow-sm">
                                        <div className="flex justify-between items-center mb-4">
                                            <span className="font-bold text-slate-800">{h.label || 'ä¿®æ­£æ¡ˆ'}</span>
                                            <span className="text-xs text-gray-400 bg-white border border-gray-200 px-2 py-0.5 rounded-full">ä¸€èˆ¬ä¿®æ³•</span>
                                        </div>
                                        <div className="flex items-center justify-between relative px-2">
                                            <div className="absolute top-2.5 left-[16%] right-[16%] h-[2px] bg-slate-300 z-0"></div>
                                            {steps.map((step, idx) => {
                                                const hasDate = !!step.date;
                                                const isWarning = !hasDate;
                                                return (
                                                    <div key={step.key} className="flex flex-col items-center flex-1 relative z-10">
                                                        <div className={`w-5 h-5 rounded-full flex items-center justify-center text-[10px] border-2 transition-colors duration-300 z-10 ${hasDate ? 'bg-primary-600 border-primary-600 text-white' : (isWarning ? 'bg-white border-red-500 text-red-500' : 'bg-white border-gray-400 text-gray-400')}`}>
                                                            {hasDate ? <Icons.Check className="text-[8px]"/> : (isWarning && step.key !== 'univ' ? <span className="font-bold">!</span> : (idx + 1))}
                                                        </div>
                                                        <div className={`mt-2 text-xs font-bold text-center ${hasDate ? 'text-primary-700' : 'text-gray-500'}`}>{step.label}{step.suffix}</div>
                                                        <div className="mt-0.5 min-h-[16px]">{hasDate ? (<span className="text-[10px] font-num text-slate-600 bg-white px-1.5 py-0.5 rounded border border-gray-200 whitespace-nowrap">{toROC(step.date)}</span>) : null}</div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                        {h.note && <div className="mt-4 pt-2 border-t border-gray-200 text-xs text-gray-500 whitespace-pre-wrap">{h.note}</div>}
                                    </div>
                                </div>
                             );
                        })}
                    </div>
                </div>
            );
        };

        const RegulationRow = ({ reg, onUpdate, onDelete, onMoveUp, onMoveDown, isFirst, isLast, templates, onManageTemplates }) => {
            const [histOpen, setHistOpen] = useState(false);
            const [templatePickerOpen, setTemplatePickerOpen] = useState(false);
            const templateBtnRef = useRef(null);

            const latest = useMemo(() => {
                let max = '', label = 'ç„¡ç´€éŒ„', stage = 'none', type = 'standard';
                (reg.history||[]).forEach(h => {
                    const hType = h.type || 'standard';
                    if (hType === 'direct' || hType === 'name_change' || hType === 'format') {
                        if(h.univDate && h.univDate>=max) { 
                            max=h.univDate; 
                            if(h.univDate){
                                const parts = h.univDate.split('-');
                                const y = parseInt(parts[0]) - 1911;
                                const m = parseInt(parts[1]);
                                const d = parseInt(parts[2]);
                                label=`ä¾${y}å¹´${m}æœˆ${d}æ—¥${h.issueNumber||'__'}å‡½è¾¦ç†`;
                            } else {
                                label = `${h.label} (æœªç™¼æ–‡)`;
                            }
                            stage='univ'; type=hType; 
                        }
                    } else {
                         if(h.univDate && h.univDate>=max) { max=h.univDate; label=`${toROC(h.univDate)} æ ¡ç´š (${h.label})`; stage='univ'; type=hType; }
                         else if(h.collegeDate && h.collegeDate>=max) { max=h.collegeDate; label=`${toROC(h.collegeDate)} é™¢ç´š (${h.label})`; stage='college'; type=hType; }
                         else if(h.deptDate && h.deptDate>=max) { max=h.deptDate; label=`${toROC(h.deptDate)} ç³»ç´š (${h.label})`; stage='dept'; type=hType; }
                    }
                });
                return { date: max, label, stage, type };
            }, [reg.history]);

            const opts = useMemo(() => {
                const o = [{val:'', lbl:'æœªä¸Šå‚³'}];
                (reg.history||[]).forEach(h => {
                    const hType = h.type || 'standard';
                    if (hType === 'direct' || hType === 'name_change' || hType === 'format') {
                        if(h.univDate) o.push({val: h.univDate, lbl: `${toROC(h.univDate)} ${h.directUnit || 'é€•äºˆä¿®è¨‚'} (${h.label})`});
                    } else {
                        if(h.univDate) o.push({val: h.univDate, lbl: `${toROC(h.univDate)} æ ¡ç´š (${h.label})`});
                        if(h.collegeDate) o.push({val: h.collegeDate, lbl: `${toROC(h.collegeDate)} é™¢ç´š (${h.label})`});
                        if(h.deptDate) o.push({val: h.deptDate, lbl: `${toROC(h.deptDate)} ç³»ç´š (${h.label})`});
                    }
                });
                return o.sort((a,b)=>b.val.localeCompare(a.val));
            }, [reg.history]);

            const getStat = (v) => { if(!v) return 'missing'; if(!latest.date) return 'ok'; return v >= latest.date ? 'ok' : 'old'; };
            const cStat = getStat(reg.cloudVersion);
            const sStat = getStat(reg.systemVersion);
            const StatusTag = ({s}) => s==='missing' ? <span className="bg-red-50 text-red-600 border border-red-100 text-[10px] px-2 py-0.5 rounded-full font-bold flex gap-1 items-center"><Icons.Alert className="text-xs"/>æœªä¸Šå‚³</span> : s==='old' ? <span className="bg-orange-50 text-orange-600 border border-orange-100 text-[10px] px-2 py-0.5 rounded-full font-bold flex gap-1 items-center"><Icons.Clock className="text-xs"/>éèˆŠ</span> : <span className="bg-emerald-50 text-emerald-600 border border-emerald-100 text-[10px] px-2 py-0.5 rounded-full font-bold flex gap-1 items-center"><Icons.Check className="text-xs"/>åŒæ­¥</span>;
            const addHist = () => onUpdate({...reg, history: [...(reg.history||[]), {id:generateId(), label:'æ–°ä¿®æ­£', type:'standard', deptDate:'', deptMeetingType:'affairs', collegeDate:'', collegeMeetingType:'affairs', univDate:'', note:''}]});
            const updateHist = (idx, f, v) => { const h = [...reg.history]; h[idx][f]=v; onUpdate({...reg, history:h}); };
            const delHist = (idx) => confirm("åˆªé™¤ï¼Ÿ") && onUpdate({...reg, history:reg.history.filter((_,i)=>i!==idx)});

            return (
                <div className="bg-white border border-primary-200 rounded-xl p-6 mb-4 shadow-sm hover:shadow-md transition-all relative z-10 group focus-within:z-50">
                    <div className="flex flex-col md:flex-row gap-4 justify-between items-start md:items-center mb-6 pb-4 border-b border-primary-100">
                        <div className="flex-1 w-full">
                             <label className="text-[10px] font-bold text-primary-400 uppercase tracking-wider mb-1 block">æ³•è¦åç¨±</label>
                             <input className="clean-input w-full text-lg font-bold text-primary-900 pb-1" value={reg.name} onChange={e=>onUpdate({...reg, name:e.target.value})} placeholder="è¼¸å…¥åç¨±..."/>
                        </div>
                        <div className="flex items-center gap-1">
                            <button onClick={onMoveUp} disabled={isFirst} className={`p-2 rounded-lg transition-colors ${isFirst?'text-gray-200':'text-gray-400 hover:bg-primary-50 hover:text-primary-600'}`}><Icons.ArrowUp className="text-sm"/></button>
                            <button onClick={onMoveDown} disabled={isLast} className={`p-2 rounded-lg transition-colors ${isLast?'text-gray-200':'text-gray-400 hover:bg-primary-50 hover:text-primary-600'}`}><Icons.ArrowDown className="text-sm"/></button>
                            <div className="w-px h-6 bg-primary-200 mx-2"></div>
                            <button onClick={onDelete} className="p-2 text-gray-300 hover:text-red-500 rounded-lg hover:bg-red-50 transition-colors"><Icons.Trash className="text-sm"/></button>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-6">
                        <div className="bg-primary-50 border border-primary-100 rounded-lg p-4 flex flex-col justify-center">
                            <div className="text-[10px] font-bold text-primary-600 uppercase tracking-wider mb-2 flex items-center gap-2"><span className={`w-2 h-2 rounded-full ${latest.date?'bg-primary-500 animate-pulse':'bg-primary-300'}`}></span> æœ€æ–°ä¿®æ³•é€²åº¦</div>
                            <div className="font-num text-xl font-bold text-primary-800">{latest.label}</div>
                            {latest.type === 'standard' && latest.stage!=='univ'&&latest.stage!=='none'&&<div className="text-xs text-amber-600 font-bold mt-2 flex items-center gap-1"><Icons.Alert className="text-xs"/> å°šæœªå®Œæˆæ ¡ç´šå‚™æŸ¥</div>}
                            {(latest.type !== 'standard' && latest.type) && <div className="text-xs text-primary-500 font-bold mt-2 flex items-center gap-1">ğŸ”– {PROCESS_TYPES.find(p=>p.id===latest.type)?.label}</div>}
                        </div>
                        <div className={`p-4 rounded-lg border ${cStat==='ok'?'bg-white border-primary-200':'bg-red-50 border-red-200'} flex flex-col justify-center`}>
                            <div className="flex justify-between mb-2"><label className="text-[10px] font-bold text-primary-500 uppercase flex gap-1 items-center"><Icons.Cloud className="text-xs"/> ç³»æ‰€é›²ç«¯</label><StatusTag s={cStat}/></div>
                            <select value={reg.cloudVersion||''} onChange={e=>onUpdate({...reg, cloudVersion:e.target.value})} className="w-full bg-transparent text-sm font-bold text-primary-700 outline-none cursor-pointer py-1 border-b border-transparent hover:border-primary-300 transition-colors">{opts.map((o,i)=><option key={i} value={o.val}>{o.lbl}</option>)}</select>
                        </div>
                        <div className={`p-4 rounded-lg border ${sStat==='ok'?'bg-white border-primary-200':'bg-red-50 border-red-200'} flex flex-col justify-center`}>
                            <div className="flex justify-between mb-2"><label className="text-[10px] font-bold text-primary-500 uppercase flex gap-1 items-center"><Icons.Scale className="text-xs"/> æ³•è¦ç³»çµ±</label><StatusTag s={sStat}/></div>
                            <select value={reg.systemVersion||''} onChange={e=>onUpdate({...reg, systemVersion:e.target.value})} className="w-full bg-transparent text-sm font-bold text-primary-700 outline-none cursor-pointer py-1 border-b border-transparent hover:border-primary-300 transition-colors">{opts.map((o,i)=><option key={i} value={o.val}>{o.lbl}</option>)}</select>
                        </div>
                    </div>

                    <div className="border-t border-primary-100 pt-4 mt-6">
                         <div className="space-y-3">
                            <div className="flex items-center justify-between cursor-pointer group" onClick={()=>setHistOpen(!histOpen)}>
                                <h5 className="text-xs font-bold text-primary-400 uppercase tracking-wider flex items-center gap-1"><Icons.History className="text-xs"/> ä¿®æ³•æ­·ç¨‹ {histOpen ? <Icons.ChevronUp className="text-xs"/> : <Icons.ChevronDown className="text-xs"/>}</h5>
                                <button onClick={(e)=>{e.stopPropagation(); addHist(); setHistOpen(true);}} className="text-xs text-primary-600 font-bold hover:bg-primary-50 px-3 py-1.5 rounded-lg flex gap-1 items-center transition-colors"><Icons.Plus className="text-xs"/> æ–°å¢æ­·ç¨‹</button>
                            </div>
                            {histOpen && (
                                <div className="space-y-4 animate-fade-in">
                                    <Timeline history={reg.history} />
                                    {(reg.history||[]).map((h,i) => {
                                        const isDirect = h.type !== 'standard' && h.type !== undefined;
                                        return (
                                            <div key={h.id} className="bg-primary-50 rounded-lg p-4 text-sm border border-primary-100 flex flex-col gap-3">
                                                <div className="flex justify-between items-start gap-4">
                                                    <div className="flex-1 grid grid-cols-1 md:grid-cols-2 gap-4">
                                                        <div className="space-y-1">
                                                            <label className="text-[10px] font-bold text-primary-400 uppercase">æ­·ç¨‹åç¨±</label>
                                                            <input className="clean-input w-full text-sm font-bold text-primary-700 pb-1" value={h.label} onChange={e=>updateHist(i,'label',e.target.value)} placeholder="åç¨±"/>
                                                        </div>
                                                        <div className="space-y-1">
                                                            <label className="text-[10px] font-bold text-primary-400 uppercase">ä¿®æ³•é¡å‹</label>
                                                            <select value={h.type || 'standard'} onChange={e=>updateHist(i,'type',e.target.value)} className="clean-input w-full text-xs text-primary-600 font-bold pb-1 cursor-pointer">
                                                                {PROCESS_TYPES.map(pt=><option key={pt.id} value={pt.id}>{pt.label}</option>)}
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <button onClick={()=>delHist(i)} className="text-gray-300 hover:text-red-500 p-1.5 rounded hover:bg-white transition-all"><Icons.Trash className="text-base"/></button>
                                                </div>
                                                {isDirect ? (
                                                    <div className="grid grid-cols-3 gap-4">
                                                        <div className="space-y-1">
                                                            <label className="text-[10px] font-bold text-primary-400 uppercase">æˆæ¬Šå–®ä½/ä¾æ“š</label>
                                                            <input className="clean-input w-full text-sm text-primary-800 pb-1" value={h.directUnit || ''} onChange={e=>updateHist(i, 'directUnit', e.target.value)} placeholder="ä¾‹å¦‚ï¼šæ•™å‹™è™•"/>
                                                        </div>
                                                        <div className="space-y-1">
                                                            <label className="text-[10px] font-bold text-primary-400 uppercase">ç™¼æ–‡å­—è™Ÿ</label>
                                                            <input className="clean-input w-full text-sm text-primary-800 pb-1" value={h.issueNumber || ''} onChange={e=>updateHist(i, 'issueNumber', e.target.value)} placeholder="å­—è™Ÿ"/>
                                                        </div>
                                                        <div className="space-y-1">
                                                            <DateInput label="ç™¼æ–‡æ—¥æœŸ" dateValue={h.univDate} onChange={v=>updateHist(i,'univDate',v)} placeholder="æ—¥æœŸ"/>
                                                        </div>
                                                    </div>
                                                ) : (
                                                    <div className="grid grid-cols-3 gap-4">
                                                        <div className="space-y-1 relative">
                                                            <div className="flex justify-between items-end">
                                                                <label className="text-[10px] font-bold text-primary-400 uppercase block mb-0.5">ç³»ç´š</label>
                                                                <select value={h.deptMeetingType||'affairs'} onChange={e=>updateHist(i,'deptMeetingType',e.target.value)} className="text-[10px] bg-transparent text-primary-500 font-bold outline-none cursor-pointer">
                                                                    {DEPT_MEETING_TYPES.map(t=><option key={t.val} value={t.val}>{t.label}</option>)}
                                                                </select>
                                                            </div>
                                                            <div className="flex items-center gap-2">
                                                                <div className="flex-1"><DateInput label="" dateValue={h.deptDate} onChange={v=>updateHist(i,'deptDate',v)} placeholder="æ—¥æœŸ"/></div>
                                                                <VerificationButton isVerified={h.deptVerified} onToggle={()=>updateHist(i, 'deptVerified', !h.deptVerified)} label="ç³»ç´šç´€éŒ„ç¢ºèª" />
                                                            </div>
                                                        </div>
                                                        <div className="space-y-1 relative">
                                                            <div className="flex justify-between items-end">
                                                                <label className="text-[10px] font-bold text-primary-400 uppercase block mb-0.5">é™¢ç´š</label>
                                                                <select value={h.collegeMeetingType||'affairs'} onChange={e=>updateHist(i,'collegeMeetingType',e.target.value)} className="text-[10px] bg-transparent text-primary-500 font-bold outline-none cursor-pointer">
                                                                    {COLLEGE_MEETING_TYPES.map(t=><option key={t.val} value={t.val}>{t.label}</option>)}
                                                                </select>
                                                            </div>
                                                            <div className="flex items-center gap-2">
                                                                <div className="flex-1"><DateInput label="" dateValue={h.collegeDate} onChange={v=>updateHist(i,'collegeDate',v)} placeholder="æ—¥æœŸ"/></div>
                                                                <VerificationButton isVerified={h.collegeVerified} onToggle={()=>updateHist(i, 'collegeVerified', !h.collegeVerified)} label="é™¢ç´šç´€éŒ„ç¢ºèª" />
                                                            </div>
                                                        </div>
                                                        <div className="space-y-1">
                                                            <div className="flex justify-between items-end">
                                                                <label className="text-[10px] font-bold text-primary-400 uppercase block mb-0.5">æ ¡ç´š</label>
                                                                <span className="text-[10px] text-primary-300 font-bold">å¯¦ç¿’å§”å“¡æœƒ</span>
                                                            </div>
                                                            <div className="flex items-center gap-2">
                                                                <div className="flex-1"><DateInput label="" dateValue={h.univDate} onChange={v=>updateHist(i,'univDate',v)} placeholder="æ—¥æœŸ"/></div>
                                                                <VerificationButton isVerified={h.univVerified} onToggle={()=>updateHist(i, 'univVerified', !h.univVerified)} label="æ ¡ç´šç´€éŒ„ç¢ºèª" />
                                                            </div>
                                                        </div>
                                                    </div>
                                                )}
                                                <div className="space-y-1">
                                                    <label className="text-[10px] font-bold text-primary-400 uppercase">å‚™è¨»èªªæ˜</label>
                                                    <textarea className="clean-input w-full text-xs text-primary-700 h-10 resize-y" value={h.note||''} onChange={e=>updateHist(i,'note',e.target.value)} placeholder="å‚™è¨»..."></textarea>
                                                </div>
                                            </div>
                                        );
                                    })}
                                    {(reg.history||[]).length===0 && <div className="text-center text-xs text-gray-400 py-4 border-2 border-dashed border-primary-200 rounded-xl">å°šç„¡ä¿®æ³•æ­·ç¨‹</div>}
                                </div>
                            )}
                        </div>
                    </div>

                    <div className="mt-6 pt-4 border-t border-primary-100">
                        <div className="flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between bg-gray-50 p-4 rounded-xl border border-gray-100">
                            <div className="text-xs font-bold text-primary-500 uppercase flex items-center gap-2">
                                <Icons.Wrench className="text-sm"/> æ³•è¦æŸ¥æ ¸çµæœ
                            </div>
                            <div className="flex gap-2">
                                {['pending', 'fix', 'pass'].map(status => {
                                    const isActive = (reg.checkStatus || 'pending') === status;
                                    let style = "bg-white text-gray-500 border-gray-200 hover:bg-gray-100";
                                    let icon = <Icons.Dot className="text-[8px] mr-1"/>;
                                    let label = "å¾…ç¢ºèª";
                                    if(status === 'fix') { label = "é ˆè£œæ­£"; icon = <Icons.Alert className="text-xs mr-1"/>; if(isActive) style = "bg-red-500 text-white border-red-500 shadow-md shadow-red-500/30"; }
                                    else if (status === 'pass') { label = "é€šé"; icon = <Icons.Check className="text-xs mr-1"/>; if(isActive) style = "bg-emerald-500 text-white border-emerald-500 shadow-md shadow-emerald-500/30"; }
                                    else { if(isActive) style = "bg-gray-600 text-white border-gray-600 shadow-md shadow-gray-500/30"; }
                                    return <button key={status} onClick={() => onUpdate({...reg, checkStatus: status})} className={`px-4 py-2 rounded-lg text-xs font-bold border transition-all flex items-center ${style}`}>{icon} {label}</button>;
                                })}
                            </div>
                        </div>
                    </div>
                    <div className="mt-4 pt-4 border-t border-primary-100 relative">
                        <div className="flex justify-between items-center mb-2">
                            <label className="text-[10px] font-bold text-primary-400 uppercase">æ•´é«”å‚™è¨»</label>
                            <button ref={templateBtnRef} onClick={()=>setTemplatePickerOpen(!templatePickerOpen)} className="text-xs text-primary-500 font-bold hover:bg-primary-50 px-2 py-1 rounded flex items-center gap-1 transition-colors"><Icons.Clipboard className="text-xs"/> å¼•ç”¨æ¨¡æ¿</button>
                        </div>
                        <div className="relative">
                            <textarea className="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 text-sm text-slate-700 min-h-[80px] focus:ring-2 focus:ring-primary-100 focus:border-primary-300 outline-none transition-all resize-y placeholder-gray-400" value={reg.note||''} onChange={e=>onUpdate({...reg, note:e.target.value})} placeholder="å¡«å¯«æ³•è¦æ•´é«”å‚™è¨»..."></textarea>
                            {templatePickerOpen && <NoteTemplatePicker templates={templates} onManage={onManageTemplates} onSelect={t=>{ onUpdate({...reg, note:(reg.note?reg.note+'\n':'')+t}); setTemplatePickerOpen(false); }} onClose={()=>setTemplatePickerOpen(false)} safeAreaRef={templateBtnRef}/>}
                        </div>
                    </div>
                </div>
            );
        };

        const DepartmentView = ({ dept, onUpdate, onDelete, onMoveUp, onMoveDown, isFirst, isLast, templates, onManageTemplates }) => {
            const [isCollapsed, setIsCollapsed] = useState(false);
            const rules = [...(dept.committeeRules||[]), ...(dept.internshipRules||[])];
            const issues = rules.filter(r => {
                let max = ''; (r.history||[]).forEach(h => { if(h.univDate>max) max=h.univDate; if(h.type!=='direct' && h.type!=='name_change' && h.type!=='format'){if(h.collegeDate>max) max=h.collegeDate; if(h.deptDate>max) max=h.deptDate;} });
                if (!max) return false; return (!r.cloudVersion || r.cloudVersion < max) || (!r.systemVersion || r.systemVersion < max);
            }).length;
            const moveRule = (type, idx, dir) => {
                const list = [...dept[type]]; const target = idx + dir;
                if(target < 0 || target >= list.length) return;
                [list[idx], list[target]] = [list[target], list[idx]];
                onUpdate({...dept, [type]: list});
            };
            return (
                <div className="bg-white border border-primary-200 rounded-xl shadow-sm mb-8 overflow-hidden">
                    <div className="bg-white px-8 py-5 flex justify-between items-center cursor-pointer hover:bg-slate-50 border-b border-primary-100 transition-colors" onClick={()=>setIsCollapsed(!isCollapsed)}>
                        <div className="flex items-center gap-6">
                            <button className="text-slate-400 hover:text-blue-600 transition-colors">{isCollapsed ? <Icons.ChevronDown className="w-6 h-6"/> : <Icons.ChevronUp className="w-6 h-6"/>}</button>
                            <span className="bg-slate-100 text-slate-500 text-xs px-3 py-1.5 rounded-lg font-bold uppercase tracking-wider">å­¸ç³»</span>
                            <input value={dept.name} onClick={e=>e.stopPropagation()} onChange={e=>onUpdate({...dept, name:e.target.value})} className="text-2xl font-bold bg-transparent outline-none text-slate-800"/>
                            {issues > 0 && <span className="bg-red-50 text-red-600 border border-red-100 text-xs px-3 py-1 rounded-full font-bold flex gap-1.5 items-center"><Icons.Alert className="w-4 h-4"/> {issues} éœ€æ›´æ–°</span>}
                        </div>
                        <div className="flex items-center gap-2" onClick={e=>e.stopPropagation()}>
                            <button onClick={onMoveUp} disabled={isFirst} className={`p-2 rounded-lg transition-colors ${isFirst?'text-gray-100':'text-gray-400 hover:bg-white hover:text-blue-600 hover:shadow-sm'}`}><Icons.ArrowUp className="w-5 h-5"/></button>
                            <button onClick={onMoveDown} disabled={isLast} className={`p-2 rounded-lg transition-colors ${isLast?'text-gray-100':'text-gray-400 hover:bg-white hover:text-blue-600 hover:shadow-sm'}`}><Icons.ArrowDown className="w-5 h-5"/></button>
                            <div className="w-px h-6 bg-primary-200 mx-2"></div>
                            <button onClick={onDelete} className="text-slate-300 hover:text-red-500 p-2 hover:bg-red-50 rounded-lg transition-colors"><Icons.Trash className="w-5 h-5"/></button>
                        </div>
                    </div>
                    {!isCollapsed && (
                        <div className="p-8 bg-primary-50/50 grid grid-cols-1 xl:grid-cols-2 gap-10">
                            <div>
                                <h4 className="font-bold text-primary-700 mb-4 flex items-center gap-3 border-b border-primary-200 pb-3 text-lg">å§”å“¡æœƒè¨­ç½®è¦é» <span className="text-xs bg-primary-100 text-primary-700 px-2.5 py-0.5 rounded-full">{(dept.committeeRules||[]).length}</span></h4>
                                {(dept.committeeRules||[]).map((r, i) => (
                                    <RegulationRow key={r.id} reg={r} templates={templates} onManageTemplates={onManageTemplates} onUpdate={u=>onUpdate({...dept, committeeRules: dept.committeeRules.map(x=>x.id===r.id?u:x)})} onDelete={()=>confirm("åˆªé™¤?")&&onUpdate({...dept, committeeRules: dept.committeeRules.filter(x=>x.id!==r.id)})} onMoveUp={()=>moveRule('committeeRules', i, -1)} onMoveDown={()=>moveRule('committeeRules', i, 1)} isFirst={i===0} isLast={i===dept.committeeRules.length-1} />
                                ))}
                                <button onClick={()=>onUpdate({...dept, committeeRules: [...(dept.committeeRules||[]), {id:generateId(), name:'', history:[], cloudVersion:'', systemVersion:''}]})} className="w-full py-3 border-2 border-dashed border-primary-300 text-primary-400 rounded-xl hover:border-primary-400 hover:text-primary-600 hover:bg-primary-50 transition-all font-bold flex justify-center items-center gap-2 mt-4"><Icons.Plus className="w-5 h-5"/> æ–°å¢è¦é»</button>
                            </div>
                            <div>
                                <h4 className="font-bold text-primary-700 mb-4 flex items-center gap-3 border-b border-primary-200 pb-3 text-lg">å¯¦ç¿’è¾¦æ³• <span className="text-xs bg-emerald-100 text-emerald-700 px-2.5 py-0.5 rounded-full">{(dept.internshipRules||[]).length}</span></h4>
                                {(dept.internshipRules||[]).map((r, i) => (
                                    <RegulationRow key={r.id} reg={r} templates={templates} onManageTemplates={onManageTemplates} onUpdate={u=>onUpdate({...dept, internshipRules: dept.internshipRules.map(x=>x.id===r.id?u:x)})} onDelete={()=>confirm("åˆªé™¤?")&&onUpdate({...dept, internshipRules: dept.internshipRules.filter(x=>x.id!==r.id)})} onMoveUp={()=>moveRule('internshipRules', i, -1)} onMoveDown={()=>moveRule('internshipRules', i, 1)} isFirst={i===0} isLast={i===dept.internshipRules.length-1} />
                                ))}
                                <button onClick={()=>onUpdate({...dept, internshipRules: [...(dept.internshipRules||[]), {id:generateId(), name:'', history:[], cloudVersion:'', systemVersion:''}]})} className="w-full py-3 border-2 border-dashed border-primary-300 text-primary-400 rounded-xl hover:border-emerald-400 hover:text-emerald-600 hover:bg-emerald-50 transition-all font-bold flex justify-center items-center gap-2 mt-4"><Icons.Plus className="w-5 h-5"/> æ–°å¢è¾¦æ³•</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const Dashboard = ({ data }) => {
            const stats = useMemo(() => {
                let total=0, warning=0, list=[];
                data.forEach(c => c.departments.forEach(d => {
                    [...(d.committeeRules||[]), ...(d.internshipRules||[])].forEach(r => {
                        total++;
                        let max = ''; (r.history||[]).forEach(h=>{ if(h.univDate>max) max=h.univDate; if(h.type!=='direct' && h.type!=='name_change' && h.type!=='format'){if(h.collegeDate>max) max=h.collegeDate; if(h.deptDate>max) max=h.deptDate;} });
                        const cOk = !r.cloudVersion ? false : (!max ? true : r.cloudVersion >= max);
                        const sOk = !r.systemVersion ? false : (!max ? true : r.systemVersion >= max);
                        if(!cOk || !sOk) {
                            warning++;
                            list.push({col: c.name, dept: d.name, name: r.name, issue: !cOk && !sOk ? 'é›™é‚Šæœªæ›´æ–°' : !cOk ? 'é›²ç«¯æœªæ›´æ–°' : 'ç³»çµ±æœªæ›´æ–°'});
                        }
                    });
                }));
                return { total, warning, list };
            }, [data]);
            return (
                <div className="max-w-6xl mx-auto space-y-10 animate-fade-in p-10">
                    <div className="grid grid-cols-3 gap-8">
                        <div className="bg-white p-8 rounded-2xl border border-primary-200 shadow-soft"><div className="text-primary-400 font-bold text-sm uppercase tracking-wider">ç¸½æ³•è¦æ•¸</div><div className="text-5xl font-bold text-primary-800 font-num mt-4">{stats.total}</div></div>
                        <div className="bg-white p-8 rounded-2xl border border-primary-200 shadow-soft"><div className="text-emerald-500 font-bold text-sm uppercase tracking-wider">åŒæ­¥è‰¯å¥½</div><div className="text-5xl font-bold text-emerald-600 font-num mt-4">{stats.total - stats.warning}</div></div>
                        <div className="bg-white p-8 rounded-2xl border border-primary-200 shadow-soft"><div className="text-red-500 font-bold text-sm uppercase tracking-wider">éœ€æ›´æ–°</div><div className="text-5xl font-bold text-red-600 font-num mt-4">{stats.warning}</div></div>
                    </div>
                    <div className="bg-white rounded-2xl border border-primary-200 shadow-soft overflow-hidden">
                        <div className="px-8 py-6 border-b border-primary-100 font-bold text-lg text-primary-800 flex items-center gap-3"><span className="w-1.5 h-6 bg-red-500 rounded-full"></span> å¾…è™•ç†æ¸…å–®</div>
                        <table className="w-full text-left">
                            <thead className="bg-primary-50 text-primary-500 text-sm uppercase tracking-wider font-bold"><tr><th className="px-8 py-4">å–®ä½</th><th className="px-8 py-4">æ³•è¦</th><th className="px-8 py-4">å•é¡Œ</th></tr></thead>
                            <tbody className="divide-y divide-primary-100">
                                {stats.list.length === 0 ? <tr><td colSpan="3" className="p-12 text-center text-primary-400 text-lg">ç›®å‰çš†å·²åŒæ­¥</td></tr> : stats.list.map((x,i)=><tr key={i} className="hover:bg-primary-50 transition-colors"><td className="px-8 py-4 text-primary-600 font-medium">{x.col} / {x.dept}</td><td className="px-8 py-4 font-bold text-primary-800">{x.name}</td><td className="px-8 py-4 text-red-500 font-bold flex items-center gap-2"><Icons.Alert className="text-base"/> {x.issue}</td></tr>)}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // --- NEW COMPONENT: SchoolMeetingView ---
        const SchoolMeetingView = ({ meetings, onUpdateMeetings, fullData }) => {
            const [selectedId, setSelectedId] = useState(null);
            
            // Sort meetings by date descending
            const sortedMeetings = useMemo(() => {
                return [...meetings].sort((a,b) => (b.date || '').localeCompare(a.date || ''));
            }, [meetings]);

            const activeMeeting = useMemo(() => meetings.find(m => m.id === selectedId) || sortedMeetings[0], [meetings, selectedId, sortedMeetings]);
            
            // Auto-group logic
            const matchedRegulations = useMemo(() => {
                if (!activeMeeting || !activeMeeting.date) return [];
                const list = [];
                fullData.forEach(col => {
                    col.departments.forEach(dept => {
                        [...dept.committeeRules, ...dept.internshipRules].forEach(rule => {
                            (rule.history || []).forEach(h => {
                                if (h.univDate === activeMeeting.date) {
                                    list.push({
                                        id: rule.id,
                                        colName: col.name,
                                        deptName: dept.name,
                                        ruleName: rule.name,
                                        histLabel: h.label,
                                        histType: h.type,
                                        note: h.note
                                    });
                                }
                            });
                        });
                    });
                });
                return list;
            }, [activeMeeting, fullData]);

            const addMeeting = () => {
                const newId = generateId();
                const today = new Date();
                const dateStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
                onUpdateMeetings([...meetings, { id: newId, name: 'æ–°æ ¡ç´šæœƒè­°', date: dateStr, note: '' }]);
                setSelectedId(newId);
            };

            const updateActive = (field, val) => {
                onUpdateMeetings(meetings.map(m => m.id === activeMeeting.id ? { ...m, [field]: val } : m));
            };

            const deleteActive = () => {
                if(confirm("ç¢ºå®šåˆªé™¤æ­¤æœƒè­°ç´€éŒ„ï¼Ÿ")) {
                    onUpdateMeetings(meetings.filter(m => m.id !== activeMeeting.id));
                    setSelectedId(null);
                }
            };

            return (
                <div className="flex h-full animate-fade-in">
                    {/* Left List */}
                    <div className="w-80 border-r border-primary-200 bg-white flex flex-col h-full">
                        <div className="p-6 border-b border-primary-100 flex justify-between items-center bg-primary-50">
                            <h2 className="font-bold text-primary-800">æœƒè­°åˆ—è¡¨</h2>
                            <button onClick={addMeeting} className="p-2 bg-white text-blue-600 rounded-lg shadow-sm hover:bg-blue-50 transition-colors"><Icons.Plus className="text-sm"/></button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-2">
                            {sortedMeetings.map(m => (
                                <div 
                                    key={m.id} 
                                    onClick={() => setSelectedId(m.id)}
                                    className={`p-4 rounded-xl cursor-pointer border transition-all ${activeMeeting?.id === m.id ? 'bg-blue-50 border-blue-200 ring-1 ring-blue-100' : 'bg-white border-primary-100 hover:border-primary-300'}`}
                                >
                                    <div className="text-[10px] font-bold text-gray-400 font-num mb-1">{toROC(m.date)}</div>
                                    <div className={`font-bold text-sm ${activeMeeting?.id === m.id ? 'text-blue-800' : 'text-primary-700'}`}>{m.name}</div>
                                </div>
                            ))}
                            {sortedMeetings.length === 0 && <div className="text-center text-xs text-gray-400 py-8">é»æ“Š + æ–°å¢æœƒè­°</div>}
                        </div>
                    </div>

                    {/* Right Details */}
                    <div className="flex-1 overflow-y-auto bg-[#f4f7fb] p-8">
                        {activeMeeting ? (
                            <div className="max-w-4xl mx-auto">
                                <div className="bg-white rounded-2xl shadow-soft border border-primary-200 p-8 mb-8">
                                    <div className="flex justify-between items-start mb-6">
                                        <div className="flex items-center gap-4">
                                            <div className="w-14 h-14 bg-blue-50 rounded-2xl flex items-center justify-center text-blue-600"><Icons.Gavel className="text-2xl"/></div>
                                            <div>
                                                <div className="text-xs font-bold text-primary-400 uppercase tracking-widest mb-1">æ ¡ç´šå¯¦ç¿’å§”å“¡æœƒ</div>
                                                <input value={activeMeeting.name} onChange={e=>updateActive('name', e.target.value)} className="bg-transparent text-2xl font-bold text-primary-800 outline-none border-b border-transparent hover:border-gray-200 focus:border-blue-300 transition-colors w-full"/>
                                            </div>
                                        </div>
                                        <button onClick={deleteActive} className="text-gray-300 hover:text-red-500 p-2"><Icons.Trash className="text-lg"/></button>
                                    </div>
                                    
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                        <div className="space-y-1">
                                            <DateInput label="æœƒè­°å¬é–‹æ—¥æœŸ" dateValue={activeMeeting.date} onChange={v=>updateActive('date', v)} />
                                            <div className="text-[10px] text-gray-400 px-1 pt-1">* ç³»çµ±å°‡è‡ªå‹•æŠ“å–æ‰€æœ‰æ³•è¦ä¸­ã€Œæ ¡ç´šé€šéæ—¥æœŸã€ç‚ºæ­¤æ—¥æœŸçš„é …ç›®</div>
                                        </div>
                                        <div className="space-y-1">
                                            <label className="text-[10px] font-bold text-primary-400 uppercase">æœƒè­°å‚™è¨»</label>
                                            <textarea className="clean-input w-full text-sm text-primary-700 h-[52px] resize-none bg-gray-50/50 p-2 rounded border border-gray-100" value={activeMeeting.note} onChange={e=>updateActive('note', e.target.value)} placeholder="å‚™è¨»äº‹é …..."></textarea>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <h3 className="text-lg font-bold text-primary-800 mb-4 flex items-center gap-2">
                                        é€šéæ³•è¦ä¸€è¦½ 
                                        <span className="bg-blue-100 text-blue-700 text-xs px-2 py-0.5 rounded-full font-num">{matchedRegulations.length}</span>
                                    </h3>
                                    
                                    {matchedRegulations.length === 0 ? (
                                        <div className="bg-white border-2 border-dashed border-primary-200 rounded-xl p-12 text-center text-primary-400 flex flex-col items-center gap-2">
                                            <Icons.ScaleBalanced className="text-3xl opacity-20"/>
                                            <p>æ­¤æ—¥æœŸå°šç„¡ä»»ä½•æ³•è¦é€šéç´€éŒ„</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-3">
                                            {matchedRegulations.map((item, idx) => (
                                                <div key={idx} className="bg-white p-4 rounded-xl border border-primary-100 shadow-sm flex items-center gap-4 hover:shadow-md transition-shadow">
                                                    <div className="w-10 h-10 bg-primary-50 rounded-full flex items-center justify-center text-primary-600 font-bold text-xs font-num">{idx+1}</div>
                                                    <div className="flex-1">
                                                        <div className="flex items-center gap-2 mb-1">
                                                            <span className="text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded">{item.colName}</span>
                                                            <span className="text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded">{item.deptName}</span>
                                                            {item.histType !== 'standard' && <span className="text-[10px] bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded">{PROCESS_TYPES.find(p=>p.id===item.histType)?.label}</span>}
                                                        </div>
                                                        <div className="font-bold text-primary-800">{item.ruleName}</div>
                                                        <div className="text-xs text-gray-500 mt-1">ä¿®æ­£å…§å®¹ï¼š{item.histLabel}</div>
                                                    </div>
                                                    {item.note && (
                                                        <div className="max-w-xs text-xs text-gray-400 bg-gray-50 p-2 rounded border border-gray-100">
                                                            {item.note}
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        ) : (
                            <div className="h-full flex flex-col items-center justify-center text-primary-300">
                                <Icons.Gavel className="text-6xl mb-4 opacity-20"/>
                                <p>è«‹é¸æ“‡æˆ–æ–°å¢æœƒè­°ç´€éŒ„</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [data, setData] = useState(() => {
                const saved = localStorage.getItem('reg_tracker_pro_v15');
                try { return saved ? JSON.parse(saved) : []; } catch { return []; }
            });
            const [templates, setTemplates] = useState(() => {
                const saved = localStorage.getItem('reg_tracker_templates');
                try { return saved ? JSON.parse(saved) : DEFAULT_NOTE_TEMPLATES; } catch { return DEFAULT_NOTE_TEMPLATES; }
            });
            // New State for Meetings
            const [meetings, setMeetings] = useState(() => {
                const saved = localStorage.getItem('reg_tracker_meetings');
                try { return saved ? JSON.parse(saved) : []; } catch { return []; }
            });

            const [activeTab, setActiveTab] = useState({ type: 'dashboard' }); 
            const [expandedColleges, setExpandedColleges] = useState({});
            const [manageTemplates, setManageTemplates] = useState(false);

            useEffect(() => localStorage.setItem('reg_tracker_pro_v15', JSON.stringify(data)), [data]);
            useEffect(() => localStorage.setItem('reg_tracker_templates', JSON.stringify(templates)), [templates]);
            useEffect(() => localStorage.setItem('reg_tracker_meetings', JSON.stringify(meetings)), [meetings]);

            const addCollege = () => {
                const id = generateId();
                setData([...data, { id, name: 'æ–°å­¸é™¢', departments: [] }]);
                setExpandedColleges(prev => ({ ...prev, [id]: true }));
            };

            const addDept = (colId) => {
                const newDepts = data.map(c => {
                    if (c.id === colId) {
                        return { ...c, departments: [...c.departments, { id: generateId(), name: 'æ–°å­¸ç³»', committeeRules: [], internshipRules: [] }] };
                    }
                    return c;
                });
                setData(newDepts);
                setExpandedColleges(prev => ({ ...prev, [colId]: true }));
            };

            const updateCollege = (updated) => setData(data.map(c => c.id === updated.id ? updated : c));
            const deleteCollege = (id) => confirm("åˆªé™¤æ•´å€‹å­¸é™¢ï¼Ÿ") && setData(data.filter(c => c.id !== id));
            
            const toggleCollege = (id) => {
                setExpandedColleges(prev => ({ ...prev, [id]: !prev[id] }));
            };

            const moveCol = (idx, dir) => {
                const n = [...data];
                const t = idx + dir;
                if(t < 0 || t >= n.length) return;
                [n[idx], n[t]] = [n[t], n[idx]];
                setData(n);
            };

            const handleExport = () => {
                if (typeof XLSX === 'undefined') { alert("åŒ¯å‡ºåŠŸèƒ½æœªè¼‰å…¥"); return; }
                const rows = [];
                data.forEach(c => c.departments.forEach(d => {
                    const push = (t, r) => rows.push({'å­¸é™¢': c.name, 'å­¸ç³»': d.name, 'é¡å‹': t, 'æ³•è¦åç¨±': r.name, 'é›²ç«¯ç‰ˆæœ¬': r.cloudVersion, 'ç³»çµ±ç‰ˆæœ¬': r.systemVersion, 'å‚™è¨»': r.note});
                    (d.committeeRules||[]).forEach(r => push('å§”å“¡æœƒ', r));
                    (d.internshipRules||[]).forEach(r => push('å¯¦ç¿’', r));
                }));
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(rows), "Report");
                XLSX.writeFile(wb, `Report.xlsx`);
            };

            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const parsed = JSON.parse(evt.target.result); 
                        if(Array.isArray(parsed)) { setData(parsed); } else { alert("æ ¼å¼ä¸ç¬¦"); }
                    } catch(err) { alert("è®€å–å¤±æ•—"); }
                };
                reader.readAsText(file);
            };

            const handleJSONExport = () => {
                const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
            };
            
            const activeCollege = activeTab.type === 'college' ? data.find(c => c.id === activeTab.id) : null;
            const activeDepartment = activeTab.type === 'dept' 
                ? data.find(c => c.departments.some(d => d.id === activeTab.id))?.departments.find(d => d.id === activeTab.id)
                : null;
            
            const getParentCollege = (deptId) => data.find(c => c.departments.some(d => d.id === deptId));

            return (
                <div className="flex h-screen overflow-hidden bg-white font-sans text-primary-800">
                    <aside className="w-72 bg-white border-r border-primary-200 flex flex-col z-20 shadow-sm relative">
                        <div className="p-6 border-b border-primary-100 flex items-center gap-4">
                            <div className="text-primary-600 bg-primary-50 p-2 rounded-xl"><Icons.ScaleBalanced className="text-2xl"/></div>
                            <div>
                                <div className="text-[10px] font-bold text-primary-400 uppercase tracking-widest leading-none mb-1">æ±æµ·å¤§å­¸å¯¦ç¿’èˆ‡å­¸ç”Ÿæˆå°±ä¸­å¿ƒ</div>
                                <h1 className="text-lg font-bold text-primary-800 leading-tight">ç³»æ‰€æ³•è¦æ§ç®¡ç³»çµ±</h1>
                            </div>
                        </div>
                        <nav className="flex-1 overflow-y-auto p-4 space-y-1">
                            <button onClick={()=>setActiveTab({type: 'dashboard'})} className={`nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-bold mb-1 rounded-lg ${activeTab.type==='dashboard'?'active':''}`}><Icons.Home className="text-base"/> ç¸½è¡¨å„€è¡¨æ¿</button>
                            
                            {/* New Navigation Item */}
                            <button onClick={()=>setActiveTab({type: 'meetings'})} className={`nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-bold mb-4 rounded-lg ${activeTab.type==='meetings'?'active':''}`}><Icons.Gavel className="text-base"/> æ ¡ç´šæœƒè­°ç´€éŒ„</button>

                            <div className="px-4 text-[10px] font-bold uppercase text-primary-400 tracking-wider mb-2 flex justify-between items-center">
                                <span>å­¸é™¢åˆ—è¡¨</span>
                                <button onClick={addCollege} className="text-primary-600 hover:bg-primary-50 p-1 rounded"><Icons.Plus className="text-base"/></button>
                            </div>

                            {data.map((c, idx) => (
                                <div key={c.id} className="mb-1">
                                    <div className={`nav-item flex items-center justify-between px-4 py-2 text-sm font-medium cursor-pointer rounded-lg ${activeTab.id===c.id && activeTab.type==='college' ? 'active' : ''}`}
                                        onClick={() => toggleCollege(c.id)}>
                                        <div className="flex items-center gap-2 truncate flex-1" onClick={(e) => { e.stopPropagation(); setActiveTab({ type: 'college', id: c.id }); }}>
                                            {expandedColleges[c.id] ? <Icons.ChevronDown className="text-xs text-primary-400"/> : <Icons.ChevronRight className="text-xs text-primary-400"/>}
                                            <div className="flex gap-2 items-center"><Icons.Building className="text-sm text-primary-400" /> <span className="truncate">{c.name}</span></div>
                                        </div>
                                        <div className="hidden group-hover:flex gap-1" onClick={e=>e.stopPropagation()}>
                                            <button onClick={()=>moveCol(idx,-1)} disabled={idx===0} className={`p-1 rounded ${idx===0?'text-primary-300':'hover:text-primary-600 hover:bg-white shadow-sm'}`}><Icons.ArrowUp className="text-xs"/></button>
                                            <button onClick={()=>moveCol(idx,1)} disabled={idx===data.length-1} className={`p-1 rounded ${idx===data.length-1?'text-primary-300':'hover:text-primary-600 hover:bg-white shadow-sm'}`}><Icons.ArrowDown className="text-xs"/></button>
                                            <button onClick={(e) => { e.stopPropagation(); addDept(c.id); }} className="p-1 text-primary-400 hover:text-primary-600 hover:bg-white shadow-sm" title="æ–°å¢å­¸ç³»"><Icons.Plus className="text-xs"/></button>
                                        </div>
                                    </div>
                                    
                                    {expandedColleges[c.id] && (
                                        <div className="mt-1 space-y-0.5">
                                            {c.departments.map(d => (
                                                <button 
                                                    key={d.id} 
                                                    onClick={() => setActiveTab({ type: 'dept', id: d.id })}
                                                    className={`w-full text-left pl-12 pr-4 py-2 text-sm transition-colors truncate block border-l-2 ml-4 flex items-center gap-2 rounded-r-lg ${activeTab.id === d.id ? 'border-primary-500 text-primary-600 font-bold bg-primary-50/50' : 'border-primary-100 text-primary-500 hover:border-primary-300 hover:text-primary-700'}`}
                                                >
                                                    <Icons.Dept className="text-sm opacity-70" /> {d.name}
                                                </button>
                                            ))}
                                            {c.departments.length === 0 && (
                                                <div className="pl-10 pr-4 py-2 text-xs text-primary-400 italic">å°šç„¡å­¸ç³»</div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            ))}
                        </nav>
                        <div className="p-4 border-t border-primary-100 flex gap-2">
                             <label className="cursor-pointer flex-1 bg-white border border-primary-200 hover:bg-primary-50 text-primary-600 py-2.5 rounded-lg text-xs font-bold flex justify-center items-center gap-2 transition-colors shadow-sm"><Icons.Upload className="text-sm"/> åŒ¯å…¥<input type="file" className="hidden" onChange={handleImport}/></label>
                             <button onClick={handleJSONExport} className="flex-1 bg-primary-600 hover:bg-primary-700 text-white text-xs font-bold py-2.5 rounded-lg flex justify-center items-center gap-2 transition-colors shadow-md shadow-primary-500/20"><Icons.Save className="text-sm"/> å‚™ä»½</button>
                        </div>
                    </aside>
                    <main className="flex-1 flex flex-col min-w-0 bg-[#f4f7fb] overflow-hidden relative">
                        <div className="flex-1 overflow-y-auto p-10 scroll-smooth">
                            {activeTab.type === 'dashboard' ? (
                                <Dashboard data={data}/>
                            ) : activeTab.type === 'meetings' ? (
                                <SchoolMeetingView meetings={meetings} onUpdateMeetings={setMeetings} fullData={data} />
                            ) : activeTab.type === 'college' && activeCollege ? (
                                <div className="max-w-4xl mx-auto animate-fade-in pb-20">
                                    <div className="bg-white rounded-2xl shadow-soft border border-primary-200 p-8 mb-8">
                                        <div className="flex items-center gap-4 mb-6">
                                            <div className="w-16 h-16 bg-primary-50 rounded-2xl flex items-center justify-center text-primary-600"><Icons.Building className="text-2xl"/></div>
                                            <div className="flex-1">
                                                <div className="text-xs font-bold text-primary-400 uppercase tracking-widest mb-1">å­¸é™¢ç®¡ç†</div>
                                                <input 
                                                    value={activeCollege.name} 
                                                    onChange={(e)=>updateCollege({...activeCollege, name:e.target.value})} 
                                                    className="bg-transparent border-none outline-none text-3xl font-bold text-primary-800 w-full hover:bg-white/20 rounded px-2 transition-colors"
                                                />
                                            </div>
                                        </div>
                                        <div className="space-y-4">
                                            <h3 className="font-bold text-primary-700 text-lg border-b border-primary-100 pb-2">æ‰€å±¬å­¸ç³» ({activeCollege.departments.length})</h3>
                                            {activeCollege.departments.map((d, i) => (
                                                <div key={d.id} className="flex items-center justify-between p-4 bg-primary-50 rounded-lg border border-primary-100 hover:border-primary-200 transition-colors group">
                                                    <span className="font-bold text-primary-700 flex items-center gap-2"><Icons.Dept className="text-primary-400"/> {d.name}</span>
                                                    <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                        <button onClick={() => setActiveTab({ type: 'dept', id: d.id })} className="text-xs bg-white border border-primary-200 px-3 py-1.5 rounded-lg font-bold text-primary-600 hover:bg-primary-50 btn-action">ç®¡ç†æ³•è¦</button>
                                                        <button onClick={() => {
                                                            if(confirm("åˆªé™¤å­¸ç³»?")) {
                                                                updateCollege({...activeCollege, departments: activeCollege.departments.filter(dept => dept.id !== d.id)});
                                                            }
                                                        }} className="text-primary-400 hover:text-red-500 p-1"><Icons.Trash className="text-base"/></button>
                                                    </div>
                                                </div>
                                            ))}
                                            <button onClick={() => addDept(activeCollege.id)} className="w-full py-4 border-2 border-dashed border-primary-300 rounded-lg text-primary-400 font-bold hover:border-primary-400 hover:text-primary-600 hover:bg-primary-50 transition-all flex justify-center items-center gap-2 btn-action"><Icons.Plus className="text-base"/> æ–°å¢å­¸ç³»</button>
                                        </div>
                                        <div className="mt-8 pt-6 border-t border-primary-100 flex justify-end">
                                            <button onClick={() => deleteCollege(activeCollege.id)} className="text-red-500 hover:text-red-700 text-sm font-bold flex items-center gap-2 px-4 py-2 hover:bg-red-50 rounded-lg transition-colors btn-action"><Icons.Trash className="text-base"/> åˆªé™¤æ­¤å­¸é™¢</button>
                                        </div>
                                    </div>
                                </div>
                            ) : activeDepartment ? (
                                <div className="max-w-[1600px] mx-auto animate-fade-in pb-20">
                                    <div className="flex justify-between items-center mb-10 pb-6 border-b border-primary-200">
                                        <div className="flex items-center gap-5">
                                            <div className="w-14 h-14 bg-white rounded-2xl shadow-soft border border-primary-100 flex items-center justify-center text-primary-600"><Icons.Dept className="text-2xl"/></div>
                                            <div>
                                                <div className="text-xs font-bold text-primary-400 uppercase tracking-widest mb-1">{getParentCollege(activeDepartment.id)?.name}</div>
                                                {/* Modified Department Name Input for Transparent Style */}
                                                <input value={activeDepartment.name} onChange={(e)=>{
                                                    const parentCol = getParentCollege(activeDepartment.id);
                                                    const newDepts = parentCol.departments.map(d => d.id === activeDepartment.id ? { ...d, name: e.target.value } : d);
                                                    updateCollege({ ...parentCol, departments: newDepts });
                                                }} className="bg-transparent border-none outline-none text-3xl font-bold text-primary-800 p-0 w-full focus:ring-0 placeholder-gray-300"/>
                                            </div>
                                        </div>
                                        <button onClick={()=>{
                                            if(confirm("åˆªé™¤å­¸ç³»?")) {
                                                const parentCol = getParentCollege(activeDepartment.id);
                                                updateCollege({ ...parentCol, departments: parentCol.departments.filter(d => d.id !== activeDepartment.id) });
                                                setActiveTab({ type: 'college', id: parentCol.id });
                                            }
                                        }} className="text-primary-400 hover:text-red-600 text-sm font-bold px-5 py-2.5 hover:bg-red-50 rounded-xl transition-colors flex items-center gap-2 btn-action"><Icons.Trash className="text-base"/> åˆªé™¤å­¸ç³»</button>
                                    </div>

                                    <div className="grid grid-cols-1 xl:grid-cols-2 gap-10">
                                        <div>
                                            <h4 className="font-bold text-primary-700 mb-6 flex items-center gap-3 border-b border-primary-200 pb-3 text-lg">å§”å“¡æœƒè¨­ç½®è¦é» <span className="text-xs bg-primary-100 text-primary-700 px-2.5 py-0.5 rounded-full">{(activeDepartment.committeeRules||[]).length}</span></h4>
                                            <div className="space-y-6">
                                                {(activeDepartment.committeeRules||[]).map((r, i) => (
                                                    <RegulationRow 
                                                        key={r.id} reg={r} templates={templates} onManageTemplates={()=>setManageTemplates(true)}
                                                        onUpdate={u=>{
                                                            const parentCol = getParentCollege(activeDepartment.id);
                                                            const newDepts = parentCol.departments.map(d => {
                                                                if(d.id === activeDepartment.id) {
                                                                    return { ...d, committeeRules: d.committeeRules.map(x=>x.id===r.id?u:x) };
                                                                }
                                                                return d;
                                                            });
                                                            updateCollege({...parentCol, departments: newDepts})
                                                        }} 
                                                        onDelete={()=>confirm("åˆªé™¤?") && (() => {
                                                            const parentCol = getParentCollege(activeDepartment.id);
                                                            const newDepts = parentCol.departments.map(d => {
                                                                if(d.id === activeDepartment.id) {
                                                                    return { ...d, committeeRules: d.committeeRules.filter(x=>x.id!==r.id) };
                                                                }
                                                                return d;
                                                            });
                                                            updateCollege({...parentCol, departments: newDepts});
                                                        })()}
                                                        onMoveUp={() => {
                                                            if(i > 0) {
                                                                const parentCol = getParentCollege(activeDepartment.id);
                                                                const newDepts = parentCol.departments.map(d => {
                                                                    if(d.id === activeDepartment.id) {
                                                                        const list = [...d.committeeRules];
                                                                        [list[i], list[i-1]] = [list[i-1], list[i]];
                                                                        return { ...d, committeeRules: list };
                                                                    }
                                                                    return d;
                                                                });
                                                                updateCollege({...parentCol, departments: newDepts});
                                                            }
                                                        }}
                                                        onMoveDown={() => {
                                                            if(i < activeDepartment.committeeRules.length - 1) {
                                                                const parentCol = getParentCollege(activeDepartment.id);
                                                                const newDepts = parentCol.departments.map(d => {
                                                                    if(d.id === activeDepartment.id) {
                                                                        const list = [...d.committeeRules];
                                                                        [list[i], list[i+1]] = [list[i+1], list[i]];
                                                                        return { ...d, committeeRules: list };
                                                                    }
                                                                    return d;
                                                                });
                                                                updateCollege({...parentCol, departments: newDepts});
                                                            }
                                                        }}
                                                        isFirst={i===0} isLast={i===activeDepartment.committeeRules.length-1}
                                                    />
                                                ))}
                                            </div>
                                            <button onClick={()=>{
                                                const parentCol = getParentCollege(activeDepartment.id);
                                                const newDepts = parentCol.departments.map(d => {
                                                    if(d.id === activeDepartment.id) {
                                                        return { ...d, committeeRules: [...(d.committeeRules||[]), {id:generateId(), name:'', history:[], cloudVersion:'', systemVersion:''}] };
                                                    }
                                                    return d;
                                                });
                                                updateCollege({...parentCol, departments: newDepts});
                                            }} className="w-full py-4 border-2 border-dashed border-primary-300 text-primary-400 rounded-lg hover:border-primary-400 hover:text-primary-600 hover:bg-primary-50 transition-all font-bold flex justify-center items-center gap-2 mt-6 btn-action"><Icons.Plus className="text-base"/> æ–°å¢è¦é»</button>
                                        </div>

                                        <div>
                                            <h4 className="font-bold text-primary-700 mb-6 flex items-center gap-3 border-b border-primary-200 pb-3 text-lg">å¯¦ç¿’è¾¦æ³• <span className="text-xs bg-emerald-100 text-emerald-700 px-2.5 py-0.5 rounded-full">{(activeDepartment.internshipRules||[]).length}</span></h4>
                                            <div className="space-y-6">
                                                {(activeDepartment.internshipRules||[]).map((r, i) => (
                                                    <RegulationRow 
                                                        key={r.id} reg={r} templates={templates} onManageTemplates={()=>setManageTemplates(true)}
                                                        onUpdate={u=>{
                                                            const parentCol = getParentCollege(activeDepartment.id);
                                                            const newDepts = parentCol.departments.map(d => {
                                                                if(d.id === activeDepartment.id) {
                                                                    return { ...d, internshipRules: d.internshipRules.map(x=>x.id===r.id?u:x) };
                                                                }
                                                                return d;
                                                            });
                                                            updateCollege({...parentCol, departments: newDepts})
                                                        }} 
                                                        onDelete={()=>confirm("åˆªé™¤?") && (() => {
                                                            const parentCol = getParentCollege(activeDepartment.id);
                                                            const newDepts = parentCol.departments.map(d => {
                                                                if(d.id === activeDepartment.id) {
                                                                    return { ...d, internshipRules: d.internshipRules.filter(x=>x.id!==r.id) };
                                                                }
                                                                return d;
                                                            });
                                                            updateCollege({...parentCol, departments: newDepts});
                                                        })()}
                                                        onMoveUp={() => {
                                                            if(i > 0) {
                                                                const parentCol = getParentCollege(activeDepartment.id);
                                                                const newDepts = parentCol.departments.map(d => {
                                                                    if(d.id === activeDepartment.id) {
                                                                        const list = [...d.internshipRules];
                                                                        [list[i], list[i-1]] = [list[i-1], list[i]];
                                                                        return { ...d, internshipRules: list };
                                                                    }
                                                                    return d;
                                                                });
                                                                updateCollege({...parentCol, departments: newDepts});
                                                            }
                                                        }}
                                                        onMoveDown={() => {
                                                            if(i < activeDepartment.internshipRules.length - 1) {
                                                                const parentCol = getParentCollege(activeDepartment.id);
                                                                const newDepts = parentCol.departments.map(d => {
                                                                    if(d.id === activeDepartment.id) {
                                                                        const list = [...d.internshipRules];
                                                                        [list[i], list[i+1]] = [list[i+1], list[i]];
                                                                        return { ...d, internshipRules: list };
                                                                    }
                                                                    return d;
                                                                });
                                                                updateCollege({...parentCol, departments: newDepts});
                                                            }
                                                        }}
                                                        isFirst={i===0} isLast={i===activeDepartment.internshipRules.length-1}
                                                    />
                                                ))}
                                            </div>
                                            <button onClick={()=>{
                                                const parentCol = getParentCollege(activeDepartment.id);
                                                const newDepts = parentCol.departments.map(d => {
                                                    if(d.id === activeDepartment.id) {
                                                        return { ...d, internshipRules: [...(d.internshipRules||[]), {id:generateId(), name:'', history:[], cloudVersion:'', systemVersion:''}] };
                                                    }
                                                    return d;
                                                });
                                                updateCollege({...parentCol, departments: newDepts});
                                            }} className="w-full py-4 border-2 border-dashed border-primary-300 text-primary-400 rounded-lg hover:border-primary-400 hover:text-primary-600 hover:bg-primary-50 transition-all font-bold flex justify-center items-center gap-2 mt-6 btn-action"><Icons.Plus className="text-base"/> æ–°å¢è¾¦æ³•</button>
                                        </div>
                                    </div>
                                </div>
                            ) : null}
                        </div>
                    </main>
                    {manageTemplates && <TemplateManager templates={templates} onChange={setTemplates} onClose={()=>setManageTemplates(false)} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
