<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TXT 合併轉 PDF 工具</title>
    <!-- 使用 Tailwind CSS 進行快速樣式設計 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');

        body {
            font-family: 'Noto Sans TC', system-ui, -apple-system, sans-serif;
        }

        /* 隱藏列印區域在螢幕上 */
        #print-area {
            display: none;
        }

        /* 列印時的樣式設定 */
        @media print {
            /* 隱藏所有 UI 元素 */
            .no-print {
                display: none !important;
            }

            /* 顯示列印區域 */
            #print-area {
                display: block !important;
                background-color: white;
                color: black;
                padding: 0;
                margin: 0;
            }

            /* 設定頁面邊距 */
            @page {
                size: A4;
                margin: 20mm;
            }

            /* 每個檔案內容的樣式 */
            .file-section {
                page-break-before: always; /* 每個檔案強制換頁 */
                white-space: pre-wrap;     /* 保留原本的換行與空白 */
                font-size: 12pt;
                line-height: 1.6;
                text-align: justify;
                font-family: 'Times New Roman', 'Noto Sans TC', serif; /* 列印使用易讀字體 */
            }

            /* 第一個檔案不需要換頁 */
            .file-section:first-child {
                page-break-before: auto;
            }

            /* 標題樣式 */
            .file-title {
                font-size: 16pt;
                font-weight: bold;
                border-bottom: 2px solid #000;
                padding-bottom: 5px;
                margin-bottom: 15px;
            }
            
            .page-number {
                display: none; /* 瀏覽器通常會自己加頁碼 */
            }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen">

    <!-- UI 介面區域 (列印時會隱藏) -->
    <div class="no-print max-w-4xl mx-auto p-4 md:p-8">
        <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-slate-200">
            
            <!-- 標題列 -->
            <div class="bg-slate-800 p-6 text-white">
                <h1 class="text-2xl font-bold flex items-center gap-2">
                    <i data-lucide="file-stack" class="w-8 h-8"></i>
                    TXT 合併轉 PDF 工具 (單檔版)
                </h1>
                <p class="mt-2 text-slate-300 text-sm">
                    上傳多個文字檔 -> 自動排序 -> 透過列印轉存為 PDF
                </p>
            </div>

            <div class="p-6 space-y-6">
                
                <!-- 上傳區 -->
                <div class="relative group cursor-pointer" onclick="document.getElementById('fileInput').click()">
                    <input type="file" id="fileInput" multiple accept=".txt" class="hidden" onchange="handleFiles(this.files)">
                    <div class="border-2 border-dashed border-slate-300 bg-slate-50 hover:bg-slate-100 hover:border-slate-400 rounded-lg p-8 text-center transition-all duration-200">
                        <i data-lucide="upload" class="w-12 h-12 text-slate-500 mx-auto mb-3"></i>
                        <h3 class="text-lg font-semibold text-slate-700">點擊此處上傳 .txt 檔案</h3>
                        <p class="text-slate-500 text-sm mt-1">支援多檔案選取</p>
                    </div>
                </div>

                <!-- 操作按鈕區 -->
                <div id="action-bar" class="hidden flex flex-col md:flex-row justify-between items-center bg-slate-50 p-4 rounded-lg border border-slate-200 gap-4">
                    <span class="font-medium text-slate-600">
                        已選擇：<span id="file-count">0</span> 個檔案
                    </span>
                    
                    <div class="flex gap-2 flex-wrap justify-center">
                        <button onclick="sortFiles()" class="px-4 py-2 bg-white border border-slate-300 hover:bg-slate-100 text-slate-700 rounded-lg flex items-center gap-2 transition-colors">
                            <i data-lucide="arrow-down-a-z" class="w-4 h-4"></i> 依名稱排序
                        </button>
                        <button onclick="clearFiles()" class="px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg flex items-center gap-2 transition-colors">
                            <i data-lucide="trash-2" class="w-4 h-4"></i> 清空
                        </button>
                        <button onclick="window.print()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-md hover:shadow-lg flex items-center gap-2 transition-colors">
                            <i data-lucide="printer" class="w-4 h-4"></i> 匯出 PDF
                        </button>
                    </div>
                </div>

                <!-- 檔案列表 -->
                <div id="file-list" class="space-y-2">
                    <!-- 檔案會動態產生在這裡 -->
                    <div class="text-center py-8 text-slate-400 border border-dashed border-slate-200 rounded-lg" id="empty-msg">
                        尚未加入檔案
                    </div>
                </div>

                <!-- 教學提示 -->
                <div class="bg-blue-50 p-4 rounded-lg text-sm text-blue-800 flex items-start gap-2 border border-blue-100">
                    <i data-lucide="info" class="w-4 h-4 mt-0.5 flex-shrink-0"></i>
                    <div>
                        <p class="font-bold">如何儲存為 PDF？</p>
                        <ul class="list-disc pl-4 mt-1 space-y-1">
                            <li>點擊上方藍色的 <strong>「匯出 PDF」</strong> 按鈕。</li>
                            <li>在列印視窗的「目的地」或是「印表機」選單中，選擇 <strong>「另存為 PDF」</strong>。</li>
                            <li>按下儲存即可。</li>
                        </ul>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- 實際列印區域 (平常隱藏，列印時顯示) -->
    <div id="print-area">
        <!-- 內容會由 JavaScript 動態填入 -->
    </div>

    <script>
        // 初始化 Icon
        lucide.createIcons();

        let filesData = [];

        // 處理檔案上傳
        async function handleFiles(files) {
            const newFiles = Array.from(files).filter(f => f.type === 'text/plain');
            
            if (newFiles.length === 0) {
                alert("請選擇 .txt 文字檔");
                return;
            }

            // 讀取檔案內容
            for (let file of newFiles) {
                const text = await readFileAsText(file);
                filesData.push({
                    id: Math.random().toString(36).substr(2, 9),
                    name: file.name,
                    size: formatSize(file.size),
                    content: text
                });
            }

            renderUI();
        }

        // Promise 包裝 FileReader
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsText(file);
            });
        }

        // 格式化檔案大小
        function formatSize(bytes) {
            return (bytes / 1024).toFixed(2) + ' KB';
        }

        // 排序檔案 (自然排序)
        function sortFiles() {
            filesData.sort((a, b) => {
                return a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' });
            });
            renderUI();
        }

        // 移除單一檔案
        function removeFile(id) {
            filesData = filesData.filter(f => f.id !== id);
            renderUI();
        }

        // 清空所有檔案
        function clearFiles() {
            filesData = [];
            document.getElementById('fileInput').value = ''; // 重置 input
            renderUI();
        }

        // 渲染畫面 (同時更新 UI 列表和列印區)
        function renderUI() {
            const listContainer = document.getElementById('file-list');
            const actionBar = document.getElementById('action-bar');
            const emptyMsg = document.getElementById('empty-msg');
            const fileCount = document.getElementById('file-count');
            const printArea = document.getElementById('print-area');

            // 更新 UI 狀態
            if (filesData.length > 0) {
                actionBar.classList.remove('hidden');
                actionBar.classList.add('flex');
                if(emptyMsg) emptyMsg.style.display = 'none';
            } else {
                actionBar.classList.add('hidden');
                actionBar.classList.remove('flex');
                if(emptyMsg) emptyMsg.style.display = 'block';
            }

            fileCount.textContent = filesData.length;

            // 1. 渲染 UI 列表
            listContainer.innerHTML = '';
            if (filesData.length === 0) {
                listContainer.appendChild(emptyMsg);
            }

            filesData.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between bg-white p-3 rounded-lg border border-slate-200 shadow-sm hover:border-slate-300 transition-colors';
                item.innerHTML = `
                    <div class="flex items-center gap-3 flex-1 overflow-hidden">
                        <span class="text-slate-400 font-mono text-sm w-6 text-center">${index + 1}.</span>
                        <div class="min-w-0">
                            <h4 class="font-medium text-slate-800 truncate text-sm">${file.name}</h4>
                            <p class="text-xs text-slate-500">${file.size}</p>
                        </div>
                    </div>
                    <button onclick="removeFile('${file.id}')" class="text-slate-300 hover:text-red-500 p-2 transition-colors">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                `;
                listContainer.appendChild(item);
            });

            // 重新初始化動態加入的 icon
            lucide.createIcons();

            // 2. 渲染列印區域 (這才是轉 PDF 的重點)
            printArea.innerHTML = '';
            filesData.forEach(file => {
                const section = document.createElement('div');
                section.className = 'file-section';
                section.innerHTML = `
                    <div class="file-title">${file.name}</div>
                    <div>${escapeHtml(file.content)}</div>
                `;
                printArea.appendChild(section);
            });
        }

        // 簡單的 HTML 跳脫防止 XSS (雖然是本地使用，安全習慣還是要有)
        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>

